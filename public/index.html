<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Host - Plugin Demo Iframe</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: #0f172a;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
      }
      .under-controls {
        position: absolute; /* detach from flow so it does not push game */
        width: 240px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 50;
      }
      header {
        padding: 12px 16px;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      header a {
        color: #0ea5e9;
        text-decoration: none;
      }
      main {
        flex: 1;
        display: grid;
        grid-template-columns: 300px 1fr 360px; /* left controls, stage, right sidebar */
        align-items: stretch;
        gap: 0;
      }
      /* Prevent controls panel from shrinking or reflowing */
      .controls-panel { min-width: 300px; max-width: 300px; }
      .stage {
        min-width: 0;
        display: grid;
        place-items: start center; /* top align, center horizontally within its grid column */
        position: relative;
        padding-top: 100px; /* original spacing below header */
      }
      .viewport {
        position: relative;
        width: 240px;
        height: 282px;
        background: #000;
        border: 1px solid #e2e8f0;
        border-radius: 0;
        overflow: hidden;
        z-index: 200; /* below overlay (300), below input panel (350) */
        margin-left: -50px; /* offset 50px left of column center */
      }
      .statusbar {
        position: absolute;
        top: 0;
        left: 0;
        width: 240px;
        height: 28px;
        color: #e5e7eb; /* slate-200 */
        background: rgba(17, 24, 39, 0.7); /* slate-900 @70% */
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0 6px;
        box-sizing: border-box;
        font-size: 12px;
        line-height: 1;
        user-select: none;
      }
      .status-left { justify-self: start; display: inline-flex; gap: 6px; align-items: center; }
      .status-center { justify-self: center; font-variant-numeric: tabular-nums; }
      .status-right { justify-self: end; font-variant-numeric: tabular-nums; }
      .viewport iframe {
        position: absolute;
        top: 28px; /* push down below status bar */
        left: 0;
        width: 240px;
        height: 254px; /* 282 - 28 */
        border: 0;
        background: #000;
        /* native scale */
      }
      .overlay-img {
        position: fixed;
        width: auto;
        height: auto;
        max-width: none;
        pointer-events: none;
        transform-origin: top left;
        image-rendering: auto;
        z-index: 300; /* above viewport */
      }
      .input-panel {
        position: fixed;
        width: 44px;
        height: 254px; /* match iframe content height */
        background: transparent;           /* hide visuals */
        border: 0;                         /* hide visuals */
        border-radius: 6px;
        box-sizing: border-box;
        z-index: 350; /* above overlay (300), above viewport (200) */
        cursor: pointer;
        user-select: none;
      }
      .controls-panel {
        border-right: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
        overflow: auto;
        overscroll-behavior: contain;
      }
      aside {
        border-left: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .qr-card {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }
      .qr-url {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        color: #334155;
        font-size: 12px;
        word-break: break-all;
        text-align: center;
      }
      .bar {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .url {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        color: #64748b;
      }
      .card {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        border-radius: 8px;
        padding: 12px;
      }
      .label { font-size: 12px; color: #64748b; }
      .row { display: flex; gap: 8px; align-items: center; }
      .grid { display: grid; gap: 8px; }
      .two { grid-template-columns: 1fr 1fr; }
      .input, .textarea {
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 10px;
        outline: none;
        font-size: 14px;
      }
      .input:focus, .textarea:focus { border-color: #0ea5e9; box-shadow: 0 0 0 3px rgba(14,165,233,0.15); }
      .textarea { min-height: 72px; resize: vertical; }
      .btn {
        background: linear-gradient(180deg, rgba(14,165,233,0.18), rgba(14,165,233,0.12));
        color: #0f172a;
        border: 1px solid rgba(14,165,233,0.35);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        word-break: break-word;
      }
    </style>
    
  </head>
  <body>
    <header>
      <div class="bar">
        <strong>Host</strong>
        <span class="url">/ball</span>
        <div style="flex:1"></div>
        <label class="label" for="creation-select">Open creation:</label>
        <select id="creation-select" class="input" style="width: 260px;"></select>
        <div class="row" style="margin-left:12px; align-items:center;">
          <input id="dev-tools-toggle" type="checkbox" />
          <label class="label" for="dev-tools-toggle" style="margin-left:6px;">Dev Tools</label>
        </div>
      </div>
    </header>
    <main>
      <div class="controls-panel" id="controls-panel">
        <div class="card" id="overlay-card" style="display:none;">
          <strong>Overlay Controls</strong>
          <div class="grid">
            <div>
              <div class="label">X Position</div>
              <div class="row">
                <input id="ov-x" class="input" type="range" min="-240" max="240" value="-93" step="1" />
                <input id="ov-x-num" class="input" type="number" min="-240" max="240" step="1" value="-93" style="width: 96px;" />
              </div>
            </div>
            <div>
              <div class="label">Y Position</div>
              <div class="row">
                <input id="ov-y" class="input" type="range" min="-240" max="240" value="-17" step="1" />
                <input id="ov-y-num" class="input" type="number" min="-240" max="240" step="1" value="-17" style="width: 96px;" />
              </div>
            </div>
            <div>
              <div class="label">Overlay Scale</div>
              <div class="row">
                <input id="ov-scale" class="input" type="range" min="0.4" max="1" step="0.001" value="0.49" />
                <input id="ov-scale-num" class="input" type="number" min="0.4" max="1" step="0.001" value="0.49" style="width: 96px;" />
              </div>
            </div>
            <div class="row">
              <button id="ov-reset" class="btn" type="button">Reset</button>
            </div>
          </div>
        </div>

        <div class="card" id="panel-card" style="display:none;">
          <strong>Scroll Panel Controls</strong>
          <div class="grid">
            <div class="two">
              <div>
                <div class="label">Panel X Offset (px)</div>
                <div class="row">
                  <input id="panel-x" class="input" type="range" min="0" max="200" value="30" step="1" />
                  <input id="panel-x-num" class="input" type="number" min="0" max="200" step="1" value="30" style="width: 96px;" />
                </div>
              </div>
              <div>
                <div class="label">Panel Y Offset (px)</div>
                <div class="row">
                  <input id="panel-y" class="input" type="range" min="0" max="200" value="1" step="1" />
                  <input id="panel-y-num" class="input" type="number" min="0" max="200" step="1" value="1" style="width: 96px;" />
                </div>
              </div>
            </div>
            <div class="two">
              <div>
                <div class="label">Panel Width (px)</div>
                <div class="row">
                  <input id="panel-w" class="input" type="range" min="24" max="120" value="120" step="1" />
                  <input id="panel-w-num" class="input" type="number" min="24" max="120" step="1" value="120" style="width: 96px;" />
                </div>
              </div>
              <div>
                <div class="label">Panel Height (px)</div>
                <div class="row">
                  <input id="panel-h" class="input" type="range" min="80" max="300" value="254" step="1" />
                  <input id="panel-h-num" class="input" type="number" min="80" max="300" step="1" value="254" style="width: 96px;" />
                </div>
              </div>
            </div>
            <div class="row">
              <button id="panel-reset" class="btn" type="button">Reset Panel</button>
            </div>
          </div>
        </div>

        <div class="card" id="emulator-card">
          <strong>Emulator Controls</strong>
          <div class="grid">
            <div>
              <div class="label">Scroll Ticks per Event (1–200)</div>
              <div class="row">
                <input id="emu-scroll-ticks" class="input" type="range" min="1" max="200" value="8" step="1" />
                <input id="emu-scroll-ticks-num" class="input" type="number" min="1" max="200" step="1" value="8" style="width: 96px;" />
              </div>
            </div>
            <div class="two">
              <div>
                <div class="label">Tilt X (-1..1)</div>
                <div class="row">
                  <input id="emu-tilt-x" class="input" type="range" min="-1" max="1" value="0" step="0.01" />
                  <input id="emu-tilt-x-num" class="input" type="number" min="-1" max="1" step="0.01" value="0" style="width: 96px;" />
                </div>
              </div>
              <div>
                <div class="label">Tilt Y (-1..1)</div>
                <div class="row">
                  <input id="emu-tilt-y" class="input" type="range" min="-1" max="1" value="0" step="0.01" />
                  <input id="emu-tilt-y-num" class="input" type="number" min="-1" max="1" step="0.01" value="0" style="width: 96px;" />
                </div>
              </div>
            </div>
            <div>
              <div class="label">Tilt Z (-1..1)</div>
              <div class="row">
                <input id="emu-tilt-z" class="input" type="range" min="-1" max="1" value="1" step="0.01" />
                <input id="emu-tilt-z-num" class="input" type="number" min="-1" max="1" step="0.01" value="1" style="width: 96px;" />
              </div>
            </div>
            <div class="row">
              <button id="emu-reset" class="btn" type="button">Reset Tilt (R)</button>
              <div style="flex:1"></div>
              <div class="label">Freq</div>
              <input id="emu-freq" class="input" type="number" min="1" max="120" step="1" value="60" style="width: 80px;" />
            </div>
            <div class="row">
              <button id="emu-sideclick" class="btn" type="button">Side Click (Space)</button>
              <button id="emu-longpress" class="btn" type="button">Long Press (hold Space)</button>
            </div>
            <div class="row">
              <button id="emu-scroll-up" class="btn" type="button">Scroll Up (↑)</button>
              <button id="emu-scroll-down" class="btn" type="button">Scroll Down (↓)</button>
            </div>
            <div class="row">
              <label class="label" style="margin-right:8px;">Enable Emulator</label>
              <input id="emu-enabled" type="checkbox" checked />
              <div style="flex:1"></div>
              <span id="emu-status" class="label">Active</span>
            </div>
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="viewport" id="viewport">
          <div class="statusbar" id="statusbar">
            <div class="status-left"><span aria-hidden="true">←</span><span>Back</span></div>
            <div class="status-center" id="status-time">00:00</div>
            <div class="status-right" id="status-batt">Batt —</div>
          </div>
          <iframe src="about:blank" allow="camera; microphone; clipboard-read; clipboard-write; autoplay"></iframe>
        </div>
        <img id="overlay" class="overlay-img" src="/r1.png" alt="Overlay" />
        <div id="input-panel" class="input-panel" title="Scroll here • Click for Side Button"></div>
        
      </div>
      <aside>
        <div class="card">
          <strong>Generated QR</strong>
          <div class="qr-card">
            <img id="json-qr-img" width="260" height="260" alt="JSON QR" />
          </div>
          <div class="label">Share URL</div>
          <div class="row">
            <input id="share-url" class="input mono" type="text" readonly placeholder="Share URL will appear here" />
            <button id="btn-copy" class="btn" type="button">Copy</button>
            <button id="btn-download" class="btn" type="button">Download PNG</button>
          </div>
        </div>
        <div class="card">
          <strong>JSON QR (auto-filled)</strong>
          <div class="grid">
            <div class="two">
              <div>
                <div class="label">Title</div>
                <input id="f-title" class="input" type="text" placeholder="Enter title" />
              </div>
              <div>
                <div class="label">URL</div>
                <input id="f-url" class="input" type="url" placeholder="https://example.com" />
              </div>
            </div>
            <div>
              <div class="label">Description</div>
              <textarea id="f-description" class="textarea" placeholder="Enter description"></textarea>
            </div>
            <div class="two">
              <div>
                <div class="label">Icon URL</div>
                <input id="f-icon" class="input" type="url" placeholder="https://.../icon.png" />
              </div>
              <div>
                <div class="label">Theme Color</div>
                <input id="f-color" class="input" type="text" value="#FE5000" pattern="^#[0-9A-Fa-f]{6}$" placeholder="#FE5000" />
              </div>
            </div>
            <div class="row">
              <button id="btn-generate" class="btn" type="button">Generate</button>
              <div style="flex:1"></div>
            </div>
          </div>
        </div>
      </aside>
    </main>
    <script>
      function isLocalhostUrl(urlString) {
        try {
          const u = new URL(urlString);
          return u.hostname === 'localhost' || u.hostname === '127.0.0.1' || u.hostname === '::1';
        } catch (_) {
          return false;
        }
      }

      function isPrivateIPv4(ip) {
        if (!ip) return false;
        if (ip.startsWith('10.')) return true;
        if (ip.startsWith('192.168.')) return true;
        if (ip.startsWith('172.')) {
          const parts = ip.split('.');
          const second = parseInt(parts[1] || '0', 10);
          return second >= 16 && second <= 31;
        }
        return false;
      }

      // Resolve the ball demo URL using the current domain
      function resolveBallUrl(){
        // Always use the current domain that the user is actually on
        return window.location.origin + '/ball/';
      }

      // ===== JSON QR on main page =====
      function encodeBase64Url(s) {
        return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
      }
      function decodeBase64Url(s) {
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        while (s.length % 4) s += '=';
        return atob(s);
      }
      function getFormData(){
        const get = id => document.getElementById(id).value.trim();
        return {
          title: get('f-title'),
          url: (function(){
            const sel = document.getElementById('creation-select');
            const chosen = sel && sel.value ? sel.value : get('f-url');
            return chosen;
          })(),
          description: get('f-description'),
          iconUrl: get('f-icon'),
          themeColor: document.getElementById('f-color').value || '#FE5000'
        };
      }
      function updateShareUrl(){
        const data = getFormData();
        const input = document.getElementById('share-url');
        if (!data.url) { input.value = ''; return; }
        // Just use the direct URL from the form
        input.value = data.url;
      }
      async function generateJsonQr(){
        const data = getFormData();
        if (!data.title && !data.url && !data.description) return;
        const img = document.getElementById('json-qr-img');
        const payload = JSON.stringify(data);
        const { toDataURL } = await import('./js/qr-lib.js');
        img.src = await toDataURL(payload, { width: 260, margin: 1 });
        updateShareUrl();
      }
      function downloadJsonQr(){
        const img = document.getElementById('json-qr-img');
        if (!img || !img.naturalWidth) return;
        const size = 300; const pad = 16; const footer = 26;
        const out = document.createElement('canvas');
        out.width = size + pad*2; out.height = size + pad*2 + footer;
        const ctx = out.getContext('2d');
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,out.width,out.height);
        ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 3; ctx.strokeRect(6,6,out.width-12,out.height-footer-12);
        ctx.drawImage(img, pad, pad, size, size);
        ctx.fillStyle = '#0f172a'; ctx.font = 'bold 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
        ctx.textAlign = 'center'; ctx.fillText('r1 creations', out.width/2, out.height-8);
        const a = document.createElement('a'); a.download = 'qr-json.png'; a.href = out.toDataURL('image/png'); a.click();
      }
      function copyShare(){
        const input = document.getElementById('share-url');
        if (!input.value) return;
        navigator.clipboard.writeText(input.value).catch(() => { input.select(); document.execCommand('copy'); });
      }
      function applyDataToForm(data){
        const set = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined) el.value = v; };
        set('f-title', data.title);
        set('f-url', data.url);
        set('f-description', data.description);
        set('f-icon', data.iconUrl);
        set('f-color', data.themeColor || '#FE5000');
      }
      async function autoFillFromParamsOrNetwork(){
        // 1) Prefer ?jsondata=
        const params = new URLSearchParams(window.location.search);
        const enc = params.get('jsondata');
        if (enc) {
          try {
            const raw = decodeBase64Url(enc);
            const data = JSON.parse(raw);
            applyDataToForm(data);
            await generateJsonQr();
            return;
          } catch (_) { /* fallthrough */ }
        }
        // 2) Else auto-fill with ball demo URL using current domain
        const url = resolveBallUrl();
        const data = {
          title: 'Bouncing Ball',
          url,
          description: 'Bounce up! Use scroll wheel to move left and right',
          iconUrl: '',
          themeColor: '#FE5000'
        };
        applyDataToForm(data);
        await generateJsonQr();
      }

      document.addEventListener('DOMContentLoaded', async () => {
        // Dev Tools toggle (defaults to hidden). Persist state in localStorage
        const overlayCard = document.getElementById('overlay-card');
        const panelCard = document.getElementById('panel-card');
        const devToggle = document.getElementById('dev-tools-toggle');
        function setDevTools(on){
          if (overlayCard) overlayCard.style.display = on ? '' : 'none';
          if (panelCard) panelCard.style.display = on ? '' : 'none';
          localStorage.setItem('devTools', on ? '1' : '0');
        }
        const savedDev = localStorage.getItem('devTools') === '1';
        if (devToggle) devToggle.checked = savedDev;
        setDevTools(!!savedDev);
        devToggle?.addEventListener('change', () => setDevTools(!!devToggle.checked));
        // Populate creations dropdown
        try {
          // Prefer static file pre-generated by build script to avoid API routing issues
          let items = [];
          try {
            const r = await fetch('/creations.json', { cache: 'no-store' });
            if (r.ok) {
              const j = await r.json();
              items = Array.isArray(j.items) ? j.items : [];
            }
          } catch (_) {}
          if (!items.length) {
            const r2 = await fetch('/api/creations', { cache: 'no-store' });
            if (!r2.ok) throw new Error('status ' + r2.status);
            const j2 = await r2.json();
            items = Array.isArray(j2.items) ? j2.items : [];
          }
          const sel = document.getElementById('creation-select');
          sel.innerHTML = '';
          const def = document.createElement('option');
          def.value = ''; def.textContent = 'Select a creation…';
          sel.appendChild(def);
          if (items.length === 0) {
            const none = document.createElement('option');
            none.value = ''; none.textContent = 'No creations found';
            sel.appendChild(none);
            sel.disabled = true;
          } else {
            for (const item of items) {
              const opt = document.createElement('option');
              // Build an absolute URL anchored to the current origin
              const path = (item.url || '').startsWith('/') ? item.url : `/${item.url || ''}`;
              const href = new URL(path, window.location.origin).href;
              opt.value = href;
              opt.textContent = item.label || href;
              sel.appendChild(opt);
            }
            sel.disabled = false;
            // Restore last selected creation if available, else auto-select first
            const frame = document.querySelector('.viewport iframe');
            const currentSrc = (frame && frame.getAttribute('src')) || '';
            const saved = localStorage.getItem('lastCreationUrl') || '';
            const findOptionIndexByValue = (v) => {
              for (let i = 0; i < sel.options.length; i++) {
                if (sel.options[i].value === v) return i;
              }
              return -1;
            };
            const savedIdx = saved ? findOptionIndexByValue(saved) : -1;
            const shouldAutoSelect = !currentSrc || currentSrc === 'about:blank' || currentSrc.endsWith('/ball/index.html');
            if (shouldAutoSelect && sel.options.length > 1) {
              let chosenIdx = 1;
              if (savedIdx > 0) chosenIdx = savedIdx;
              sel.selectedIndex = chosenIdx;
              const href = sel.options[chosenIdx].value;
              frame.src = href;
              localStorage.setItem('lastCreationUrl', href);
              // Sync QR form URL and title to match iframe selection
              const titleEl = document.getElementById('f-title');
              const urlEl = document.getElementById('f-url');
              if (titleEl) titleEl.value = sel.options[chosenIdx].textContent || '';
              if (urlEl) urlEl.value = href;
              try { await generateJsonQr(); } catch (_) {}
            }
          }
          sel.addEventListener('change', async () => {
            if (!sel.value) return;
            const frame = document.querySelector('.viewport iframe');
            if (frame) {
              frame.src = sel.value; // absolute URL
            }
            // Persist selection
            try { localStorage.setItem('lastCreationUrl', sel.value); } catch (_) {}
            // Update QR form to match selected creation
            const titleEl = document.getElementById('f-title');
            const urlEl = document.getElementById('f-url');
            if (titleEl) titleEl.value = sel.selectedOptions[0]?.textContent || '';
            if (urlEl) urlEl.value = sel.value;
            try { await generateJsonQr(); } catch (_) {}
          });
        } catch (e) {
          const sel = document.getElementById('creation-select');
          sel.innerHTML = '';
          const def = document.createElement('option');
          def.value = ''; def.textContent = 'Failed to load creations';
          sel.appendChild(def);
          sel.disabled = true;
        }

        for (const id of ['f-title','f-url','f-description','f-icon','f-color']) {
          const el = document.getElementById(id);
          el.addEventListener('input', () => { generateJsonQr(); });
        }
        document.getElementById('btn-generate').addEventListener('click', generateJsonQr);
        document.getElementById('btn-download').addEventListener('click', downloadJsonQr);
        document.getElementById('btn-copy').addEventListener('click', copyShare);
        // Overlay controls
        const overlay = document.getElementById('overlay');
        const vp = document.getElementById('viewport');
        const sx = document.getElementById('ov-x');
        const sy = document.getElementById('ov-y');
        const ss = document.getElementById('ov-scale');
        const sxNum = document.getElementById('ov-x-num');
        const syNum = document.getElementById('ov-y-num');
        const ssNum = document.getElementById('ov-scale-num');
        const STATUSBAR_HEIGHT = 28; // px
        function applyOverlay(){
          // Position overlay relative to viewport top-left in page coordinates
          const rect = vp.getBoundingClientRect();
          const stage = document.querySelector('.stage');
          const srect = stage ? stage.getBoundingClientRect() : { left: 0, top: 0 };
          // Stage uses grid centering; we can offset overlay relative to viewport by translating
          const x = parseInt(sx.value, 10);
          const y = parseInt(sy.value, 10);
          const s = parseFloat(ss.value);
          // Position overlay relative to the iframe (viewport) in page coordinates
          const pageLeft = rect.left + x;
          const pageTop = rect.top + (y - STATUSBAR_HEIGHT);
          overlay.style.left = `${pageLeft}px`;
          overlay.style.top = `${pageTop}px`;
          overlay.style.transform = `scale(${s})`;
          overlay.style.transformOrigin = 'top left';
          // Position input panel to the right of the viewport content area
          const panel = document.getElementById('input-panel');
          if (panel) {
            const px = parseInt(document.getElementById('panel-x')?.value || '8', 10);
            const py = parseInt(document.getElementById('panel-y')?.value || '0', 10);
            const pw = parseInt(document.getElementById('panel-w')?.value || '44', 10);
            const ph = parseInt(document.getElementById('panel-h')?.value || '254', 10);
            // Anchor panel to the iframe's right edge in page coordinates; do not clamp to stage
            const pLeft = rect.right + px;
            const pTop = rect.top + STATUSBAR_HEIGHT + py;
            panel.style.left = `${pLeft}px`;
            panel.style.top = `${pTop}px`;
            panel.style.transform = '';
            panel.style.width = `${pw}px`;
            panel.style.height = `${ph}px`;
          }
          // sync numeric inputs
          sxNum.value = x;
          syNum.value = y;
          ssNum.value = s.toFixed(2);
        }
        // bind both slider and number inputs
        sx.addEventListener('input', applyOverlay);
        sy.addEventListener('input', applyOverlay);
        ss.addEventListener('input', applyOverlay);
        sxNum.addEventListener('input', () => { sx.value = sxNum.value; applyOverlay(); });
        syNum.addEventListener('input', () => { sy.value = syNum.value; applyOverlay(); });
        ssNum.addEventListener('input', () => { ss.value = ssNum.value; applyOverlay(); });
        document.getElementById('ov-reset').addEventListener('click', () => { sx.value = -31; sy.value = -91; ss.value = 0.49; applyOverlay(); });
        // keep overlay, panel, and under-controls locked to iframe position on resize/scroll
        window.addEventListener('resize', applyOverlay);
        window.addEventListener('scroll', applyOverlay, { passive: true });
        // React to viewport size/layout changes precisely
        try {
          const ro = new ResizeObserver(() => applyOverlay());
          ro.observe(vp);
        } catch (_) { /* ignore if not supported */ }
        // Set requested defaults
        sx.value = '-33';
        sy.value = '-17';
        ss.value = '0.49';
        applyOverlay();
        // Input panel interactions: wheel -> scrollUp/Down, click -> sideClick
        (function bindInputPanel(){
          const panel = document.getElementById('input-panel');
          if (!panel) return;
          // Wheel with threshold to avoid firing on tiny scrolls (uses emulator sensitivity slider)
          let panelWheelSteps = 0;
          panel.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const dir = (e.deltaY || 0) > 0 ? 'down' : 'up';
            panelWheelSteps += 1;
            const ticksEl = document.getElementById('emu-scroll-ticks');
            let needed = parseInt((ticksEl && ticksEl.value) || '8', 10);
            if (!Number.isFinite(needed)) needed = 8;
            if (needed < 1) needed = 1;
            if (needed > 200) needed = 200;
            if (panelWheelSteps >= needed) {
              panelWheelSteps = 0;
              try {
                const frameWin = document.querySelector('.viewport iframe')?.contentWindow;
                if (frameWin) {
                  frameWin.scrollBy({ top: dir === 'down' ? 80 : -80, behavior: 'smooth' });
                  frameWin.dispatchEvent(new CustomEvent(dir === 'down' ? 'scrollDown' : 'scrollUp', { detail: { source: 'panel' } }));
                }
              } catch (_) {}
            }
          }, { passive: false });

          // Click maps to side button
          panel.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            try {
              const frameWin = document.querySelector('.viewport iframe')?.contentWindow;
              frameWin?.dispatchEvent(new CustomEvent('sideClick', { detail: { source: 'panel' } }));
            } catch (_) {}
          });
          // Panel sliders wiring
          const pairs = [
            ['panel-x','panel-x-num'],
            ['panel-y','panel-y-num'],
            ['panel-w','panel-w-num'],
            ['panel-h','panel-h-num'],
          ];
          for (const [rId, nId] of pairs) {
            const r = document.getElementById(rId);
            const n = document.getElementById(nId);
            if (r) r.addEventListener('input', () => { if (n) n.value = r.value; applyOverlay(); });
            if (n) n.addEventListener('input', () => { if (r) r.value = n.value; applyOverlay(); });
          }
          const resetBtn = document.getElementById('panel-reset');
          if (resetBtn) resetBtn.addEventListener('click', () => {
            const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = String(v); };
            set('panel-x', 8); set('panel-x-num', 8);
            set('panel-y', 28); set('panel-y-num', 28);
            set('panel-w', 44); set('panel-w-num', 44);
            set('panel-h', 254); set('panel-h-num', 254);
            applyOverlay();
          });
        })();

        // Position under-controls below the viewport (absolute)
        (function positionUnderControls(){
          const uc = document.getElementById('under-controls');
          const stage = document.querySelector('.stage');
          const vpRect = vp.getBoundingClientRect();
          const stRect = stage ? stage.getBoundingClientRect() : { left: 0, top: 0 };
          const ucLeft = (vpRect.left - stRect.left);
          const ucTop = (vpRect.bottom - stRect.top) + 8; // 8px gap
          if (uc) {
            uc.style.left = `${ucLeft}px`;
            uc.style.top = `${ucTop}px`;
          }
          // Reposition on changes
          window.addEventListener('resize', positionUnderControls);
          window.addEventListener('scroll', positionUnderControls, { passive: true });
        })();

        // Simple time display (center)
        function pad2(n){ return String(n).padStart(2,'0'); }
        function updateTime(){
          const now = new Date();
          const hh = pad2(now.getHours());
          const mm = pad2(now.getMinutes());
          document.getElementById('status-time').textContent = `${hh}:${mm}`;
        }
        updateTime();
        setInterval(updateTime, 30 * 1000);

        // Battery status (right) if supported
        (async () => {
          try {
            if (navigator.getBattery) {
              const batt = await navigator.getBattery();
              const el = document.getElementById('status-batt');
              const fmt = () => {
                const pct = Math.round((batt.level || 0) * 100);
                el.textContent = `Batt ${pct}%`;
              };
              fmt();
              batt.addEventListener('levelchange', fmt);
              batt.addEventListener('chargingchange', fmt);
            }
          } catch (_) { /* ignore */ }
        })();

        await autoFillFromParamsOrNetwork();
      });
      
    </script>
    <script src="./js/emulator-shim.js"></script>
  </body>
  </html>


