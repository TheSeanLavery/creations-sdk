(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const s of l)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(l){const s={};return l.integrity&&(s.integrity=l.integrity),l.referrerPolicy&&(s.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?s.credentials="include":l.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(l){if(l.ep)return;l.ep=!0;const s=n(l);fetch(l.href,s)}})();class Z{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],l=i.indexOf(n);l>-1&&i.splice(l,1)}}const N=new Z;class Q{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const ee=new Q;function z(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function te(t,e,n){const i=z(t,t.VERTEX_SHADER,e),l=z(t,t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,i),t.attachShader(s,l),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const ne=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,ie=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function se(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=te(e,ne,ie);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),l=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,l,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const d=8;let u=512,x=0,B=new Float32Array(u*d);const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,B.byteLength,e.DYNAMIC_DRAW);const o=d*4;let f=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(1,1),f+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(2,1),f+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,o,f),e.vertexAttribDivisor(3,1),f+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,o,f),e.vertexAttribDivisor(4,1);function w(y){if(y<=u)return;let m=u;for(;m<y;)m*=2;const I=new Float32Array(m*d);I.set(B.subarray(0,x*d)),B=I,u=m,e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,B.byteLength,e.DYNAMIC_DRAW)}function M(){const y=Math.min(window.devicePixelRatio||1,2),m=Math.floor(t.clientWidth*y),I=Math.floor(t.clientHeight*y);return(t.width!==m||t.height!==I)&&(t.width=m,t.height=I),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:y}}function b(){e.clear(e.COLOR_BUFFER_BIT)}function p(y,m){w(m),x=m,B.set(y.subarray(0,m*d),0),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferSubData(e.ARRAY_BUFFER,0,B.subarray(0,m*d))}function E(){x!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,x))}return{gl:e,floatsPerInstance:d,resize:M,beginFrame:b,setInstances:p,draw:E}}function T(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class L{constructor(e,n,i,l){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=l,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:l}=this.bounds,s=i*.5,c=l*.5,d=this.depth+1,u=this.capacity,x=this.maxDepth;this.children=[new L({x:e,y:n,w:s,h:c},u,d,x),new L({x:e+s,y:n,w:s,h:c},u,d,x),new L({x:e,y:n+c,w:s,h:c},u,d,x),new L({x:e+s,y:n+c,w:s,h:c},u,d,x)]}insert(e){if(!T(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let l=!1;for(let s=0;s<4;s++)if(this.children[s].insert(i)){l=!0;break}l?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!T(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const l=this.items[i];T(e,l)&&n.push(l)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class re{constructor(e,n=16,i=8){this.root=new L(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new L(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,l,s){const c={x:e,y:n,w:i,h:l,ref:s};this.root.insert(c)}queryRect(e,n,i,l,s=[]){return this.root.query({x:e,y:n,w:i,h:l},s)}}function le(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[]}}function oe(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function ae(t,e,n,i=0,l=-1,s=240){const c=Math.max(1e-4,Math.hypot(i,l));t.playerBullets.push({x:e,y:n,vx:i/c*s,vy:l/c*s,w:4,h:8})}function ce(t,e,n,i=0,l=1,s=160){const c=Math.max(1e-4,Math.hypot(i,l));t.enemyBullets.push({x:e,y:n,vx:i/c*s,vy:l/c*s,w:4,h:8})}function he(t,e){t.time+=e;for(let n=0;n<t.playerBullets.length;n++){const i=t.playerBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.playerBullets[n]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),n--)}for(let n=0;n<t.enemyBullets.length;n++){const i=t.enemyBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.enemyBullets[n]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),n--)}for(let n=0;n<t.enemies.length;n++){const i=t.enemies[n];i.x+=i.vx*e,i.y+=i.vy*e,i.y>t.height+40&&(t.enemies[n]=t.enemies[t.enemies.length-1],t.enemies.pop(),n--)}}function ue(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}const h={world:{playerLives:3,playerInvincibleMs:2e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,scrollImpulse:40,autoFireInterval:.09,autoBulletSpeed:300,spray:{count:5,spreadDeg:24}},enemy:{speedMin:40,speedMax:70,fireInterval:.6,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.9,minInterval:.25,accelPerSec:.03}}};ee.setupViewport();N.init();const F=document.getElementById("glcanvas"),P=se(F),r=le();r.player.x=0;r.player.y=-r.height+h.world.bottomYOffsetPx;r.player.lives=h.world.playerLives;const v=document.createElement("div");v.style.position="fixed";v.style.left="8px";v.style.top="8px";v.style.padding="4px 6px";v.style.background="rgba(0,0,0,0.5)";v.style.color="#0f0";v.style.fontFamily="monospace";v.style.fontSize="12px";v.style.zIndex="1000";v.style.pointerEvents="none";document.body.appendChild(v);const de=1e3;let _=[],R=0,H=performance.now(),W=!0;const A=new Set;window.addEventListener("keydown",t=>{A.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{A.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let k=!1;N.on("sideButton",()=>{k=!0});N.on("scrollWheel",({direction:t})=>{if(!r.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===G&&n-K<fe?Y+=1:Y=1,K=n,G=i,S+=i*Y*ye});let D=0,U=0,V=0,S=0,K=0,G=0,Y=1;const fe=2e3,ye=h.player.scrollImpulse,pe=h.player.keyAccel,$=h.player.maxKeySpeed,me=16384,q=P.floatsPerInstance;let g=new Float32Array(me*q),O=0;function C(t,e,n,i,l,s,c,d){const u=O*q;u+q>g.length||(g[u]=t,g[u+1]=e,g[u+2]=n,g[u+3]=i,g[u+4]=l,g[u+5]=s,g[u+6]=c,g[u+7]=d,O++)}function X(t,e,n,i,l,s,c,d){return!(t+n*.5<l-c*.5||l+c*.5<t-n*.5||e+i*.5<s-d*.5||s+d*.5<e-i*.5)}function j(t){const{width:e,height:n}=P.resize();r.width=e*.5,r.height=n*.5;const i=t-H;for(H=t,_.push(i),R+=i;R>de&&_.length>0;)R-=_.shift();if(_.length>0){const a=_.length,o=R/a,f=1e3/Math.max(1e-4,o),w=_.map(p=>1e3/Math.max(1e-4,p)).sort((p,E)=>p-E),M=Math.max(0,Math.floor(.01*a)),b=w[M];v.textContent=`fps ${f.toFixed(1)} | 1% ${b.toFixed(1)} | vsync ${W?"on":"off"}`}const l=Math.max(0,Math.min(.05,i*.001)),s=r.player,c=h.player.moveSpeedY;let d=0,u=0;if((A.has("arrowleft")||A.has("a"))&&(d-=1),(A.has("arrowright")||A.has("d"))&&(d+=1),(A.has("arrowup")||A.has("w"))&&(u-=1),(A.has("arrowdown")||A.has("s"))&&(u+=1),u!==0){const a=u/Math.abs(u);s.y+=a*c*l}if(d!==0){const a=d/Math.abs(d);S+=a*pe*l,Math.abs(S)>$&&(S=Math.sign(S)*$)}const x=Math.exp(-3*l);if(S*=x,s.x+=S*l,ue(r),r.time===0&&(s.x=0,s.y=-r.height+h.world.bottomYOffsetPx),D-=l,D<=0){const a=(Math.random()*2-1)*(r.width-20),o=-(h.enemy.speedMin+Math.random()*(h.enemy.speedMax-h.enemy.speedMin));oe(r,a,r.height-20,o);const f=h.enemy.spawn.baseInterval,w=h.enemy.spawn.accelPerSec*r.time;D=Math.max(h.enemy.spawn.minInterval,f-w)}if(U-=l,U<=0&&r.enemies.length>0&&s.alive){const a=r.enemies[Math.random()*r.enemies.length|0],o=s.x-a.x,f=s.y-a.y,w=h.enemy.bulletSpeedMin+Math.random()*(h.enemy.bulletSpeedMax-h.enemy.bulletSpeedMin);ce(r,a.x,a.y,o,f,w),U=h.enemy.fireInterval}if(V-=l,s.alive&&V<=0){const a=Math.max(1,h.player.spray.count|0),o=h.player.spray.spreadDeg*Math.PI/180,w=Math.PI/2-o/2,M=a>1?o/(a-1):0;for(let b=0;b<a;b++){const p=w+M*b,E=Math.cos(p),y=Math.sin(p);ae(r,s.x,s.y+12,E,y,h.player.autoBulletSpeed)}V=h.player.autoFireInterval}he(r,l),!s.alive&&s.lives<=0?k&&(r.time=0,r.enemies.length=0,r.playerBullets.length=0,r.enemyBullets.length=0,s.x=0,s.y=-r.height+h.world.bottomYOffsetPx,s.alive=!0,s.lives=h.world.playerLives,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,S=0,D=h.enemy.spawn.baseInterval,k=!1):k=!1;const B=new re({x:-r.width,y:-r.height,w:r.width*2,h:r.height*2},8,7);for(let a=0;a<r.enemies.length;a++){const o=r.enemies[a];B.insertRect(o.x-o.w*.5,o.y-o.h*.5,o.w,o.h,a)}for(let a=0;a<r.playerBullets.length;a++){const o=r.playerBullets[a],f=o.x-o.w*.5,w=o.y-o.h*.5,M=B.queryRect(f,w,o.w,o.h,[]);let b=!1;for(let p=0;p<M.length;p++){const E=M[p].ref,y=r.enemies[E];if(y&&X(o.x,o.y,o.w,o.h,y.x,y.y,y.w,y.h)){y.hp-=1,r.playerBullets[a]=r.playerBullets[r.playerBullets.length-1],r.playerBullets.pop(),a--,b=!0,y.hp<=0&&(r.enemies[E]=r.enemies[r.enemies.length-1],r.enemies.pop());break}}}if(r.player.alive)for(let a=0;a<r.enemyBullets.length;a++){const o=r.enemyBullets[a];if(!(performance.now()<s.invincibleUntil)&&X(r.player.x,r.player.y,1,1,o.x,o.y,o.w,o.h)){s.lives-=1,s.lives>0?(s.x=0,s.y=-r.height+h.world.bottomYOffsetPx,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,r.enemyBullets=r.enemyBullets.filter(f=>Math.hypot(f.x-s.x,f.y-s.y)>32),S=0):s.alive=!1;break}}O=0,P.beginFrame(),s.alive&&(!(performance.now()<s.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&C(s.x,s.y,14,18,0,.2,.9,1);for(let a=0;a<r.enemies.length;a++){const o=r.enemies[a];C(o.x,o.y,18,22,Math.PI,1,.3,.3)}for(let a=0;a<r.playerBullets.length;a++){const o=r.playerBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;C(o.x,o.y,6,10,f,1,1,.4)}for(let a=0;a<r.enemyBullets.length;a++){const o=r.enemyBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;C(o.x,o.y,6,10,f,1,.4,1)}P.setInstances(g,O),P.draw(),J()}function ve(){F.style.width||(F.style.width="100vw"),F.style.height||(F.style.height="100vh"),F.style.display="block"}ve();J();function J(){W?requestAnimationFrame(j):setTimeout(()=>j(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(W=!W)});
