(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const h of s.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&n(h)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}})();class J{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const i=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(i)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(n=>n(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(n=>n({direction:e.direction,event:e.event}))}on(e,i){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(i)}off(e,i){const n=this.eventListeners.get(e)||[],r=n.indexOf(i);r>-1&&n.splice(r,1)}}const Y=new J;class Z{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const Q=new Z;function N(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error(t.getShaderInfoLog(n)||"Shader compile error"),t.deleteShader(n),null)}function ee(t,e,i){const n=N(t,t.VERTEX_SHADER,e),r=N(t,t.FRAGMENT_SHADER,i),s=t.createProgram();return t.attachShader(s,n),t.attachShader(s,r),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const te=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,ie=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function ne(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const i=ee(e,te,ie);e.useProgram(i),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const n=e.getUniformLocation(i,"u_halfViewSize"),r=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const u=8;let c=512,m=0,w=new Float32Array(c*u);const l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,w.byteLength,e.DYNAMIC_DRAW);const a=u*4;let f=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,a,f),e.vertexAttribDivisor(1,1),f+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,a,f),e.vertexAttribDivisor(2,1),f+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,a,f),e.vertexAttribDivisor(3,1),f+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,a,f),e.vertexAttribDivisor(4,1);function L(d){if(d<=c)return;let y=c;for(;y<d;)y*=2;const F=new Float32Array(y*u);F.set(w.subarray(0,m*u)),w=F,c=y,e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,w.byteLength,e.DYNAMIC_DRAW)}function B(){const d=Math.min(window.devicePixelRatio||1,2),y=Math.floor(t.clientWidth*d),F=Math.floor(t.clientHeight*d);return(t.width!==y||t.height!==F)&&(t.width=y,t.height=F),e.viewport(0,0,t.width,t.height),e.useProgram(i),e.uniform2f(n,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:d}}function E(){e.clear(e.COLOR_BUFFER_BIT)}function b(d,y){L(y),m=y,w.set(d.subarray(0,y*u),0),e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferSubData(e.ARRAY_BUFFER,0,w.subarray(0,y*u))}function S(){m!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,m))}return{gl:e,floatsPerInstance:u,resize:B,beginFrame:E,setInstances:b,draw:S}}function W(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class A{constructor(e,i,n,r){this.bounds=e,this.capacity=i,this.depth=n,this.maxDepth=r,this.items=[],this.children=null}subdivide(){const{x:e,y:i,w:n,h:r}=this.bounds,s=n*.5,h=r*.5,u=this.depth+1,c=this.capacity,m=this.maxDepth;this.children=[new A({x:e,y:i,w:s,h},c,u,m),new A({x:e+s,y:i,w:s,h},c,u,m),new A({x:e,y:i+h,w:s,h},c,u,m),new A({x:e+s,y:i+h,w:s,h},c,u,m)]}insert(e){if(!W(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let i=0;i<this.items.length;i++){const n=this.items[i];let r=!1;for(let s=0;s<4;s++)if(this.children[s].insert(n)){r=!0;break}r?(this.items[i]=this.items[this.items.length-1],this.items.pop(),i--):this.items[i]=n}}for(let i=0;i<4;i++)if(this.children[i].insert(e))return!0;return this.items.push(e),!0}query(e,i){if(!W(this.bounds,e))return i;for(let n=0;n<this.items.length;n++){const r=this.items[n];W(e,r)&&i.push(r)}return this.children&&(this.children[0].query(e,i),this.children[1].query(e,i),this.children[2].query(e,i),this.children[3].query(e,i)),i}}class se{constructor(e,i=16,n=8){this.root=new A(e,i,0,n),this.bounds=e,this.capacity=i,this.maxDepth=n}clear(e=this.bounds){this.root=new A(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,i,n,r,s){const h={x:e,y:i,w:n,h:r,ref:s};this.root.insert(h)}queryRect(e,i,n,r,s=[]){return this.root.query({x:e,y:i,w:n,h:r},s)}}function re(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[]}}function oe(t,e,i,n=40){t.enemies.push({x:e,y:i,vx:0,vy:n,w:16,h:16,hp:3})}function le(t,e,i,n=0,r=-1,s=240){const h=Math.max(1e-4,Math.hypot(n,r));t.playerBullets.push({x:e,y:i,vx:n/h*s,vy:r/h*s,w:4,h:8})}function ae(t,e,i,n=0,r=1,s=160){const h=Math.max(1e-4,Math.hypot(n,r));t.enemyBullets.push({x:e,y:i,vx:n/h*s,vy:r/h*s,w:4,h:8})}function he(t,e){t.time+=e;for(let i=0;i<t.playerBullets.length;i++){const n=t.playerBullets[i];n.x+=n.vx*e,n.y+=n.vy*e,(n.x<-t.width||n.x>t.width||n.y<-t.height||n.y>t.height)&&(t.playerBullets[i]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),i--)}for(let i=0;i<t.enemyBullets.length;i++){const n=t.enemyBullets[i];n.x+=n.vx*e,n.y+=n.vy*e,(n.x<-t.width||n.x>t.width||n.y<-t.height||n.y>t.height)&&(t.enemyBullets[i]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),i--)}for(let i=0;i<t.enemies.length;i++){const n=t.enemies[i];n.x+=n.vx*e,n.y+=n.vy*e,n.y>t.height+40&&(t.enemies[i]=t.enemies[t.enemies.length-1],t.enemies.pop(),i--)}}function ce(t,e=8){const i=t.player;i.x=Math.max(-t.width+e,Math.min(t.width-e,i.x)),i.y=Math.max(-t.height+e,Math.min(t.height-e,i.y))}Q.setupViewport();Y.init();const _=document.getElementById("glcanvas"),R=ne(_),o=re();o.player.x=0;o.player.y=-o.height+24;const p=document.createElement("div");p.style.position="fixed";p.style.left="8px";p.style.top="8px";p.style.padding="4px 6px";p.style.background="rgba(0,0,0,0.5)";p.style.color="#0f0";p.style.fontFamily="monospace";p.style.fontSize="12px";p.style.zIndex="1000";p.style.pointerEvents="none";document.body.appendChild(p);const ue=1e3;let M=[],P=0,z=performance.now(),I=!0;const x=new Set;window.addEventListener("keydown",t=>{x.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{x.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let C=!1;Y.on("sideButton",()=>{C=!0});Y.on("scrollWheel",({direction:t})=>{if(!o.player.alive)return;const i=performance.now(),n=t==="up"?1:-1;n===K&&i-H<fe?O+=1:O=1,H=i,K=n,g+=n*O*de});let T=0,U=0,V=0,g=0,H=0,K=0,O=1;const fe=2e3,de=40,ye=1200,G=320,pe=16384,q=R.floatsPerInstance;let v=new Float32Array(pe*q),k=0;function D(t,e,i,n,r,s,h,u){const c=k*q;c+q>v.length||(v[c]=t,v[c+1]=e,v[c+2]=i,v[c+3]=n,v[c+4]=r,v[c+5]=s,v[c+6]=h,v[c+7]=u,k++)}function $(t,e,i,n,r,s,h,u){return!(t+i*.5<r-h*.5||r+h*.5<t-i*.5||e+n*.5<s-u*.5||s+u*.5<e-n*.5)}function X(t){const{width:e,height:i}=R.resize();o.width=e*.5,o.height=i*.5;const n=t-z;for(z=t,M.push(n),P+=n;P>ue&&M.length>0;)P-=M.shift();if(M.length>0){const l=M.length,a=P/l,f=1e3/Math.max(1e-4,a),L=M.map(b=>1e3/Math.max(1e-4,b)).sort((b,S)=>b-S),B=Math.max(0,Math.floor(.01*l)),E=L[B];p.textContent=`fps ${f.toFixed(1)} | 1% ${E.toFixed(1)} | vsync ${I?"on":"off"}`}const r=Math.max(0,Math.min(.05,n*.001)),s=o.player,h=180;let u=0,c=0;if((x.has("arrowleft")||x.has("a"))&&(u-=1),(x.has("arrowright")||x.has("d"))&&(u+=1),(x.has("arrowup")||x.has("w"))&&(c-=1),(x.has("arrowdown")||x.has("s"))&&(c+=1),c!==0){const l=c/Math.abs(c);s.y+=l*h*r}if(u!==0){const l=u/Math.abs(u);g+=l*ye*r,Math.abs(g)>G&&(g=Math.sign(g)*G)}const m=Math.exp(-3*r);if(g*=m,s.x+=g*r,ce(o),o.time===0&&(s.x=0,s.y=-o.height+24),T-=r,T<=0){const l=(Math.random()*2-1)*(o.width-20);oe(o,l,o.height-20,-(40+Math.random()*30)),T=.75}if(U-=r,U<=0&&o.enemies.length>0&&s.alive){const l=o.enemies[Math.random()*o.enemies.length|0],a=s.x-l.x,f=s.y-l.y;ae(o,l.x,l.y,a,f,140+Math.random()*60),U=.6}V-=r,s.alive&&V<=0&&(le(o,s.x,s.y+12,0,1,300),V=.09),he(o,r),!s.alive&&s.lives<=0?C&&(o.time=0,o.enemies.length=0,o.playerBullets.length=0,o.enemyBullets.length=0,s.x=0,s.y=-o.height+24,s.alive=!0,s.lives=3,s.invincibleUntil=performance.now()+2e3,g=0,C=!1):C=!1;const w=new se({x:-o.width,y:-o.height,w:o.width*2,h:o.height*2},8,7);for(let l=0;l<o.enemies.length;l++){const a=o.enemies[l];w.insertRect(a.x-a.w*.5,a.y-a.h*.5,a.w,a.h,l)}for(let l=0;l<o.playerBullets.length;l++){const a=o.playerBullets[l],f=a.x-a.w*.5,L=a.y-a.h*.5,B=w.queryRect(f,L,a.w,a.h,[]);let E=!1;for(let b=0;b<B.length;b++){const S=B[b].ref,d=o.enemies[S];if(d&&$(a.x,a.y,a.w,a.h,d.x,d.y,d.w,d.h)){d.hp-=1,o.playerBullets[l]=o.playerBullets[o.playerBullets.length-1],o.playerBullets.pop(),l--,E=!0,d.hp<=0&&(o.enemies[S]=o.enemies[o.enemies.length-1],o.enemies.pop());break}}}if(o.player.alive)for(let l=0;l<o.enemyBullets.length;l++){const a=o.enemyBullets[l];if(!(performance.now()<s.invincibleUntil)&&$(o.player.x,o.player.y,1,1,a.x,a.y,a.w,a.h)){s.lives-=1,s.lives>0?(s.x=0,s.y=-o.height+24,s.invincibleUntil=performance.now()+2e3,o.enemyBullets=o.enemyBullets.filter(f=>Math.hypot(f.x-s.x,f.y-s.y)>32),g=0):s.alive=!1;break}}k=0,R.beginFrame(),s.alive&&(!(performance.now()<s.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&D(s.x,s.y,14,18,0,.2,.9,1);for(let l=0;l<o.enemies.length;l++){const a=o.enemies[l];D(a.x,a.y,18,22,Math.PI,1,.3,.3)}for(let l=0;l<o.playerBullets.length;l++){const a=o.playerBullets[l],f=Math.atan2(a.vy,a.vx)-Math.PI*.5;D(a.x,a.y,6,10,f,1,1,.4)}for(let l=0;l<o.enemyBullets.length;l++){const a=o.enemyBullets[l],f=Math.atan2(a.vy,a.vx)-Math.PI*.5;D(a.x,a.y,6,10,f,1,.4,1)}R.setInstances(v,k),R.draw(),j()}function me(){_.style.width||(_.style.width="100vw"),_.style.height||(_.style.height="100vh"),_.style.display="block"}me();j();function j(){I?requestAnimationFrame(X):setTimeout(()=>X(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(I=!I)});
