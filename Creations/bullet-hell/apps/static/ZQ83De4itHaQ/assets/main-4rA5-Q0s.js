(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();class ie{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],r=i.indexOf(n);r>-1&&i.splice(r,1)}}const $=new ie;class se{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const re=new se;function G(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function le(t,e,n){const i=G(t,t.VERTEX_SHADER,e),r=G(t,t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,i),t.attachShader(s,r),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const oe=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,ae=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function ce(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=le(e,oe,ae);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),r=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const c=8;let y=512,d=0,A=new Float32Array(y*c);const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,A.byteLength,e.DYNAMIC_DRAW);const o=c*4;let f=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(1,1),f+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(2,1),f+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,o,f),e.vertexAttribDivisor(3,1),f+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,o,f),e.vertexAttribDivisor(4,1);function g(p){if(p<=y)return;let m=y;for(;m<p;)m*=2;const L=new Float32Array(m*c);L.set(A.subarray(0,d*c)),A=L,y=m,e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,A.byteLength,e.DYNAMIC_DRAW)}function E(){const p=Math.min(window.devicePixelRatio||1,2),m=Math.floor(t.clientWidth*p),L=Math.floor(t.clientHeight*p);return(t.width!==m||t.height!==L)&&(t.width=m,t.height=L),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:p}}function w(){e.clear(e.COLOR_BUFFER_BIT)}function b(p,m){g(m),d=m,A.set(p.subarray(0,m*c),0),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferSubData(e.ARRAY_BUFFER,0,A.subarray(0,m*c))}function P(){d!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,d))}return{gl:e,floatsPerInstance:c,resize:E,beginFrame:w,setInstances:b,draw:P}}function q(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class _{constructor(e,n,i,r){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=r,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:r}=this.bounds,s=i*.5,u=r*.5,c=this.depth+1,y=this.capacity,d=this.maxDepth;this.children=[new _({x:e,y:n,w:s,h:u},y,c,d),new _({x:e+s,y:n,w:s,h:u},y,c,d),new _({x:e,y:n+u,w:s,h:u},y,c,d),new _({x:e+s,y:n+u,w:s,h:u},y,c,d)]}insert(e){if(!q(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let r=!1;for(let s=0;s<4;s++)if(this.children[s].insert(i)){r=!0;break}r?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!q(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const r=this.items[i];q(e,r)&&n.push(r)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class he{constructor(e,n=16,i=8){this.root=new _(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new _(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,r,s){const u={x:e,y:n,w:i,h:r,ref:s};this.root.insert(u)}queryRect(e,n,i,r,s=[]){return this.root.query({x:e,y:n,w:i,h:r},s)}}const ue=1e4;function ye(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[],enemyBulletPool:(()=>{const t=[];for(let e=0;e<ue;e++)t.push({x:0,y:0,vx:0,vy:0,w:4,h:8});return t})()}}function fe(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function pe(t,e,n,i=0,r=-1,s=240){const u=Math.max(1e-4,Math.hypot(i,r));t.playerBullets.push({x:e,y:n,vx:i/u*s,vy:r/u*s,w:4,h:8})}function de(t,e,n,i=0,r=1,s=160){const u=Math.max(1e-4,Math.hypot(i,r)),c=t.enemyBulletPool.length>0?t.enemyBulletPool.pop():null;c&&(c.x=e,c.y=n,c.vx=i/u*s,c.vy=r/u*s,t.enemyBullets.push(c))}function me(t,e){t.time+=e;for(let n=0;n<t.playerBullets.length;n++){const i=t.playerBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.playerBullets[n]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),n--)}for(let n=0;n<t.enemyBullets.length;n++){const i=t.enemyBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.enemyBullets[n]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),t.enemyBulletPool.push(i),n--)}for(let n=0;n<t.enemies.length;n++){const i=t.enemies[n];i.x+=i.vx*e,i.y+=i.vy*e,i.y>t.height+40&&(t.enemies[n]=t.enemies[t.enemies.length-1],t.enemies.pop(),n--)}}function xe(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}function ve(t){for(let e=0;e<t.enemyBullets.length;e++)t.enemyBulletPool.push(t.enemyBullets[e]);t.enemyBullets.length=0}function be(t,e,n,i){const r=i*i;let s=0;for(let u=0;u<t.enemyBullets.length;u++){const c=t.enemyBullets[u],y=c.x-e,d=c.y-n;y*y+d*d<=r?t.enemyBulletPool.push(c):t.enemyBullets[s++]=c}t.enemyBullets.length=s}const h={world:{playerLives:3,playerInvincibleMs:4e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,frictionPerSec:3,scrollImpulse:40,autoFireInterval:.02,autoBulletSpeed:300,spray:{count:10,spreadDeg:34}},enemy:{body:{w:18,h:22},speedMin:40,speedMax:70,fireInterval:.2,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.3,minInterval:.01,accelPerSec:.06},hp:1},bullets:{size:{w:6,h:10}},quadtree:{capacity:8,maxDepth:7},scoring:{enemyKillBase:10,comboMax:9,highScoreKey:"bh_highscore"},ui:{showPerfOverlay:!0,perfOffsetTopPx:8}};re.setupViewport();$.init();const F=document.getElementById("glcanvas"),k=ce(F),l=ye();l.player.x=0;l.player.y=-l.height+h.world.bottomYOffsetPx;l.player.lives=h.world.playerLives;const v=document.createElement("div");v.style.position="fixed";v.style.left="8px";v.style.top=String(h.ui.perfOffsetTopPx)+"px";v.style.padding="4px 6px";v.style.background="rgba(0,0,0,0.5)";v.style.color="#0f0";v.style.fontFamily="monospace";v.style.fontSize="12px";v.style.zIndex="1000";v.style.pointerEvents="none";v.style.whiteSpace="pre";document.body.appendChild(v);const x=document.createElement("div");x.style.position="fixed";x.style.right="8px";x.style.top="8px";x.style.padding="4px 6px";x.style.background="rgba(0,0,0,0.5)";x.style.color="#0f0";x.style.fontFamily="monospace";x.style.fontSize="12px";x.style.zIndex="1000";x.style.pointerEvents="none";x.style.whiteSpace="pre";x.style.textAlign="right";document.body.appendChild(x);const ge=1e3;let I=[],O=0,X=performance.now(),V=!1;const S=new Set;window.addEventListener("keydown",t=>{S.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{S.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let U=!1;$.on("sideButton",()=>{U=!0});$.on("scrollWheel",({direction:t})=>{if(!l.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===J&&n-j<we?N+=1:N=1,j=n,J=i,M+=i*N*Be});let W=0,K=0,z=0,D=0,C=0,R=0;try{R=parseInt(localStorage.getItem(h.scoring.highScoreKey)||"0",10)||0}catch{R=0}function Z(t){return String((t|0)<0?0:t|0).padStart(8,"0")}let M=0,j=0,J=0,N=1;const we=2e3,Be=h.player.scrollImpulse,Se=h.player.keyAccel,Q=h.player.maxKeySpeed,Ae=16384,H=k.floatsPerInstance;let B=new Float32Array(Ae*H),Y=0;function T(t,e,n,i,r,s,u,c){const y=Y*H;y+H>B.length||(B[y]=t,B[y+1]=e,B[y+2]=n,B[y+3]=i,B[y+4]=r,B[y+5]=s,B[y+6]=u,B[y+7]=c,Y++)}function ee(t,e,n,i,r,s,u,c){return!(t+n*.5<r-u*.5||r+u*.5<t-n*.5||e+i*.5<s-c*.5||s+c*.5<e-i*.5)}function te(t){const{width:e,height:n}=k.resize();l.width=e*.5,l.height=n*.5;const i=t-X;for(X=t,I.push(i),O+=i;O>ge&&I.length>0;)O-=I.shift();if(I.length>0&&h.ui.showPerfOverlay){const a=I.length,o=O/a,f=1e3/Math.max(1e-4,o),g=I.map(b=>1e3/Math.max(1e-4,b)).sort((b,P)=>b-P),E=Math.max(0,Math.floor(.01*a)),w=g[E];v.textContent=`fps ${f.toFixed(1)}
1% ${w.toFixed(1)}
vsync ${V?"on":"off"}`}x.textContent=`score ${Z(D)}
hi ${Z(R)}`;const r=Math.max(0,Math.min(.05,i*.001)),s=l.player,u=h.player.moveSpeedY;let c=0,y=0;if((S.has("arrowleft")||S.has("a"))&&(c-=1),(S.has("arrowright")||S.has("d"))&&(c+=1),(S.has("arrowup")||S.has("w"))&&(y-=1),(S.has("arrowdown")||S.has("s"))&&(y+=1),y!==0){const a=y/Math.abs(y);s.y+=a*u*r}if(c!==0){const a=c/Math.abs(c);M+=a*Se*r,Math.abs(M)>Q&&(M=Math.sign(M)*Q)}const d=Math.exp(-3*r);if(M*=d,s.x+=M*r,xe(l),l.time===0&&(s.x=0,s.y=-l.height+h.world.bottomYOffsetPx),W-=r,W<=0){const a=(Math.random()*2-1)*(l.width-20),o=-(h.enemy.speedMin+Math.random()*(h.enemy.speedMax-h.enemy.speedMin));fe(l,a,l.height-20,o);const f=h.enemy.spawn.baseInterval,g=h.enemy.spawn.accelPerSec*l.time;W=Math.max(h.enemy.spawn.minInterval,f-g)}if(K-=r,K<=0&&l.enemies.length>0&&s.alive){const a=l.enemies[Math.random()*l.enemies.length|0],o=s.x-a.x,f=s.y-a.y,g=h.enemy.bulletSpeedMin+Math.random()*(h.enemy.bulletSpeedMax-h.enemy.bulletSpeedMin);de(l,a.x,a.y,o,f,g),K=h.enemy.fireInterval}if(z-=r,s.alive&&z<=0){const a=Math.max(1,h.player.spray.count|0),o=h.player.spray.spreadDeg*Math.PI/180,g=Math.PI/2-o/2,E=a>1?o/(a-1):0;for(let w=0;w<a;w++){const b=g+E*w,P=Math.cos(b),p=Math.sin(b);pe(l,s.x,s.y+12,P,p,h.player.autoBulletSpeed)}z=h.player.autoFireInterval}me(l,r),!s.alive&&s.lives<=0?U&&(l.time=0,l.enemies.length=0,l.playerBullets.length=0,ve(l),s.x=0,s.y=-l.height+h.world.bottomYOffsetPx,s.alive=!0,s.lives=h.world.playerLives,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,M=0,W=h.enemy.spawn.baseInterval,D=0,C=0,U=!1):U=!1;const A=new he({x:-l.width,y:-l.height,w:l.width*2,h:l.height*2},8,7);for(let a=0;a<l.enemies.length;a++){const o=l.enemies[a];A.insertRect(o.x-o.w*.5,o.y-o.h*.5,o.w,o.h,a)}for(let a=0;a<l.playerBullets.length;a++){const o=l.playerBullets[a],f=o.x-o.w*.5,g=o.y-o.h*.5,E=A.queryRect(f,g,o.w,o.h,[]);let w=!1;for(let b=0;b<E.length;b++){const P=E[b].ref,p=l.enemies[P];if(p&&ee(o.x,o.y,o.w,o.h,p.x,p.y,p.w,p.h)){if(p.hp-=1,l.playerBullets[a]=l.playerBullets[l.playerBullets.length-1],l.playerBullets.pop(),a--,w=!0,p.hp<=0){C=Math.min(h.scoring.comboMax,C+1);const m=h.scoring.enemyKillBase*Math.max(1,C)|0;if(D+=m,D>R){R=D;try{localStorage.setItem(h.scoring.highScoreKey,String(R))}catch{}}l.enemies[P]=l.enemies[l.enemies.length-1],l.enemies.pop()}break}}}if(l.player.alive)for(let a=0;a<l.enemyBullets.length;a++){const o=l.enemyBullets[a];if(!(performance.now()<s.invincibleUntil)&&ee(l.player.x,l.player.y,1,1,o.x,o.y,o.w,o.h)){s.lives-=1,C=0,s.lives>0?(s.x=0,s.y=-l.height+h.world.bottomYOffsetPx,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,be(l,s.x,s.y,32),M=0):(s.alive=!1,typeof navigator<"u"&&navigator.vibrate&&navigator.vibrate(200));break}}Y=0,k.beginFrame(),s.alive&&(!(performance.now()<s.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&T(s.x,s.y,14,18,0,.2,.9,1);for(let a=0;a<l.enemies.length;a++){const o=l.enemies[a];T(o.x,o.y,18,22,Math.PI,1,.3,.3)}for(let a=0;a<l.playerBullets.length;a++){const o=l.playerBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;T(o.x,o.y,6,10,f,1,1,.4)}for(let a=0;a<l.enemyBullets.length;a++){const o=l.enemyBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;T(o.x,o.y,6,10,f,1,.4,1)}k.setInstances(B,Y),k.draw(),ne()}function Me(){F.style.width||(F.style.width="100vw"),F.style.height||(F.style.height="100vh"),F.style.display="block"}Me();ne();function ne(){V?requestAnimationFrame(te):setTimeout(()=>te(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(V=!V)});
