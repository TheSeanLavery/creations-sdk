(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();class Fe{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],s=i.indexOf(n);s>-1&&i.splice(s,1)}}const ge=new Fe;class Re{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const Le=new Re;function xe(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function ke(t,e,n){const i=xe(t,t.VERTEX_SHADER,e),s=xe(t,t.FRAGMENT_SHADER,n),r=t.createProgram();return t.attachShader(r,i),t.attachShader(r,s),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)?r:(console.error(t.getProgramInfoLog(r)||"Program link error"),t.deleteProgram(r),null)}const Ce=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,De=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function Te(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=ke(e,Ce,De);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),s=new Float32Array([-.5,-.6,.5,-.6,0,.8]),r=e.createVertexArray();e.bindVertexArray(r);const c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const p=8;let a=512,y=0,u=new Float32Array(a*p);const f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f),e.bufferData(e.ARRAY_BUFFER,u.byteLength,e.DYNAMIC_DRAW);const S=p*4;let l=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,S,l),e.vertexAttribDivisor(1,1),l+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,S,l),e.vertexAttribDivisor(2,1),l+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,S,l),e.vertexAttribDivisor(3,1),l+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,S,l),e.vertexAttribDivisor(4,1);function h(g){if(g<=a)return;let w=a;for(;w<g;)w*=2;const v=new Float32Array(w*p);v.set(u.subarray(0,y*p)),u=v,a=w,e.bindBuffer(e.ARRAY_BUFFER,f),e.bufferData(e.ARRAY_BUFFER,u.byteLength,e.DYNAMIC_DRAW)}function d(){const g=Math.min(window.devicePixelRatio||1,2),w=Math.floor(t.clientWidth*g),v=Math.floor(t.clientHeight*g);return(t.width!==w||t.height!==v)&&(t.width=w,t.height=v),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:g}}function m(){e.clear(e.COLOR_BUFFER_BIT)}function A(g,w){h(w),y=w,u.set(g.subarray(0,w*p),0),e.bindBuffer(e.ARRAY_BUFFER,f),e.bufferSubData(e.ARRAY_BUFFER,0,u.subarray(0,w*p))}function M(){y!==0&&(e.bindVertexArray(r),e.drawArraysInstanced(e.TRIANGLES,0,3,y))}return{gl:e,floatsPerInstance:p,resize:d,beginFrame:m,setInstances:A,draw:M}}function de(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class Y{constructor(e,n,i,s){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=s,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:s}=this.bounds,r=i*.5,c=s*.5,p=this.depth+1,a=this.capacity,y=this.maxDepth;this.children=[new Y({x:e,y:n,w:r,h:c},a,p,y),new Y({x:e+r,y:n,w:r,h:c},a,p,y),new Y({x:e,y:n+c,w:r,h:c},a,p,y),new Y({x:e+r,y:n+c,w:r,h:c},a,p,y)]}insert(e){if(!de(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let s=!1;for(let r=0;r<4;r++)if(this.children[r].insert(i)){s=!0;break}s?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!de(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const s=this.items[i];de(e,s)&&n.push(s)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class ze{constructor(e,n=16,i=8){this.root=new Y(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new Y(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,s,r){const c={x:e,y:n,w:i,h:s,ref:r};this.root.insert(c)}queryRect(e,n,i,s,r=[]){return this.root.query({x:e,y:n,w:i,h:s},r)}}const We=1e4;function He(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[],coins:[],powerups:[],enemyBulletPool:(()=>{const t=[];for(let e=0;e<We;e++)t.push({x:0,y:0,vx:0,vy:0,w:4,h:8});return t})()}}function Oe(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function qe(t,e,n,i=0,s=-1,r=240){const c=Math.max(1e-4,Math.hypot(i,s));t.playerBullets.push({x:e,y:n,vx:i/c*r,vy:s/c*r,w:4,h:8})}function Ve(t,e,n,i=0,s=1,r=160,c){const p=Math.max(1e-4,Math.hypot(i,s)),a=t.enemyBulletPool.length>0?t.enemyBulletPool.pop():null;a&&(a.x=e,a.y=n,a.vx=i/p*r,a.vy=s/p*r,a.birthTime=t.time||0,a.sineAmp=0,a.sineFreqHz=0,a.sinePrevOffset=0,c&&(c.sineAmp!=null&&(a.sineAmp=c.sineAmp),c.sineFreqHz!=null&&(a.sineFreqHz=c.sineFreqHz)),t.enemyBullets.push(a))}function Ue(t,e){t.time+=e;for(let i=0;i<t.playerBullets.length;i++){const s=t.playerBullets[i];s.x+=s.vx*e,s.y+=s.vy*e,(s.x<-t.width||s.x>t.width||s.y<-t.height||s.y>t.height)&&(t.playerBullets[i]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),i--)}for(let i=0;i<t.enemyBullets.length;i++){const s=t.enemyBullets[i];if(s.sineAmp|0||s.sineFreqHz|0){const r=Math.max(1e-4,Math.hypot(s.vx,s.vy)),c=-s.vy/r,p=s.vx/r,a=t.time-(s.birthTime||0),y=(s.sineFreqHz||0)*a*Math.PI*2,u=Math.sin(y)*(s.sineAmp||0),f=u-(s.sinePrevOffset||0);s.x+=c*f,s.y+=p*f,s.sinePrevOffset=u}s.x+=s.vx*e,s.y+=s.vy*e,(s.x<-t.width||s.x>t.width||s.y<-t.height||s.y>t.height)&&(t.enemyBullets[i]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),t.enemyBulletPool.push(s),i--)}for(let i=0;i<t.enemies.length;i++){const s=t.enemies[i];s.x+=s.vx*e,s.y+=s.vy*e,s.y>t.height+40&&(t.enemies[i]=t.enemies[t.enemies.length-1],t.enemies.pop(),i--)}const n=t.player;for(let i=0;i<t.coins.length;i++){const s=t.coins[i],r=n.x-s.x,c=n.y-s.y,p=Math.max(1e-4,Math.hypot(r,c)),a=s.speed||220;s.x+=r/p*a*e,s.y+=c/p*a*e,Math.hypot(s.x-n.x,s.y-n.y)<12&&(t.coins[i]=t.coins[t.coins.length-1],t.coins.pop(),i--)}for(let i=0;i<t.powerups.length;i++){const s=t.powerups[i];s.y+=(s.vy||-40)*e,s.y<-t.height-40&&(t.powerups[i]=t.powerups[t.powerups.length-1],t.powerups.pop(),i--)}}function Ye(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}function Ge(t){for(let e=0;e<t.enemyBullets.length;e++)t.enemyBulletPool.push(t.enemyBullets[e]);t.enemyBullets.length=0}function Ke(t,e,n,i){const s=i*i;let r=0;for(let c=0;c<t.enemyBullets.length;c++){const p=t.enemyBullets[c],a=p.x-e,y=p.y-n;a*a+y*y<=s?t.enemyBulletPool.push(p):t.enemyBullets[r++]=p}t.enemyBullets.length=r}const Z=[{id:"L1",seed:12345,stages:[{id:"S1",phases:[{id:"P-popcorn-streams",actions:[{type:"spawn",enemy:"popcorn",pattern:"streamLinear",duration:8,rate:6,lane:"topRandom"},{type:"sleep",duration:2},{type:"spawn",enemy:"gunship",pattern:"burst",count:2,positions:"topLeftRightOffscreen"}]},{id:"P-bursters",actions:[{type:"sleep",duration:4},{type:"spawn",enemy:"burster",pattern:"streamRamping",duration:6,rate:{base:1.5,slope:.5}}]}],miniboss:{id:"minibossA"}},{id:"S2",phases:[{id:"P-popcorn-dense",actions:[{type:"spawn",enemy:"popcorn",pattern:"streamLinear",duration:10,rate:10}]}],boss:{id:"bossA"}}]},{id:"L2",seed:54321,stages:[{id:"S1",phases:[{id:"P-gunships",actions:[{type:"spawn",enemy:"gunship",pattern:"streamLinear",duration:8,rate:3,lane:"topLeftRightOffscreen"}]},{id:"P-bursters-more",actions:[{type:"sleep",duration:2},{type:"spawn",enemy:"burster",pattern:"streamRamping",duration:10,rate:{base:.8,slope:.6}}]}],boss:{id:"bossA"}}]}],J={popcorn:{id:"popcorn",size:{w:16,h:16},hp:1,score:10,movement:{use:"popcornDrift"},fire:{rate:1,shot:{use:"aimedSingle"}},onFireFx:{use:"onFireWindupShake"}},gunship:{id:"gunship",size:{w:22,h:20},hp:3,score:25,movement:{use:"gunshipSweep"},spawn:{side:"leftOrRightTop"},fire:null},burster:{id:"burster",size:{w:20,h:20},hp:5,score:50,movement:{use:"bursterStopAndBurst"},fire:{onPauseOnly:!0,shot:{use:"bursterVolley"}},onFireFx:{use:"onFireWindupShake"}},minibossA:{id:"minibossA",size:{w:60,h:44},hp:400,boss:!0,score:500,movement:{use:"hoverTopBand",override:{params:{yRatio:.85,sineXAmplitude:60}}},firePhases:[{duration:6,shot:{use:"spread5"}},{duration:8,shot:{use:"sineStream"}}]},bossA:{id:"bossA",size:{w:80,h:64},hp:1200,boss:!0,score:2e3,movement:{use:"hoverTopBand",override:{params:{yRatio:.88,sineXAmplitude:100}}},firePhases:[{untilHpRatio:.66,shot:{use:"spread5FastWide"}},{untilHpRatio:.33,shot:{use:"sineStream",override:{params:{rate:12}}}},{untilHpRatio:0,shot:{use:"bursterVolley"}}]}},$e={fpsCap:60},Ne={aimedSingle:{id:"aimedSingle",emit:"bullet",params:{speed:180,size:{w:6,h:10},color:[1,.9,.4],aimAtPlayer:!0}},spread5:{id:"spread5",emit:"group",params:{count:5,angleCenter:-90,angleSpreadDeg:40,speed:200,size:{w:6,h:10}}},sineStream:{id:"sineStream",emit:"sequence",params:{duration:2,rate:8,speed:180,sine:{amplitude:36,frequencyHz:2.2},size:{w:6,h:10}}},bursterVolley:{id:"bursterVolley",emit:"group",params:{count:15,angleCenter:-90,angleSpreadDeg:80,speed:160,sine:{amplitude:30,frequencyHz:3},size:{w:6,h:10}}},spread5FastWide:{use:"spread5",override:{params:{speed:240,angleSpreadDeg:60}}}};function _e(t,e){if(!e)return t;const n=Array.isArray(t)?t.slice():{...t||{}};for(const i in e){const s=t?t[i]:void 0,r=e[i];n[i]=s&&typeof s=="object"&&!Array.isArray(s)&&typeof r=="object"&&!Array.isArray(r)?_e(s,r):r}return n}function Xe(t){if(!t)return null;if(t.id&&t.params)return t;if(t.use){const e=Ne[t.use];return e?_e(e,t.override||null):null}return null}class Je{constructor(e){this.api=e}emit(e,n,i,s){const r=Xe(e);if(!r)return;const c=r.params||{};if(r.emit==="bullet"){const p=this._computeDirection(c,n,i);this.api.fireEnemyBullet(n.x,n.y,p.dx,p.dy,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0);return}if(r.emit==="group"){const p=c.count|0,a=(c.angleSpreadDeg||0)*Math.PI/180,u=(c.angleCenter!=null?c.angleCenter:-90)*Math.PI/180-a*.5,f=p>1?a/(p-1):0;for(let S=0;S<p;S++){const l=u+S*f,h=Math.cos(l),d=Math.sin(l);this.api.fireEnemyBullet(n.x,n.y,h,d,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0)}return}if(r.emit==="sequence"){const p=c.duration||0,a=c.rate||0,y=Math.max(0,Math.floor(p*a));for(let u=0;u<y;u++){const f=this._computeDirection(c,n,i);this.api.fireEnemyBullet(n.x,n.y,f.dx,f.dy,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0)}return}}_computeDirection(e,n,i){if(e.aimAtPlayer&&(i!=null&&i.target)){const r=i.target.x-n.x,c=i.target.y-n.y,p=Math.max(1e-4,Math.hypot(r,c));return{dx:r/p,dy:c/p}}const s=(e.angleCenter!=null?e.angleCenter:-90)*Math.PI/180;return{dx:Math.cos(s),dy:Math.sin(s)}}}function j(t){let e=t>>>0||1;function n(){return e^=e<<13,e>>>=0,e^=e>>>17,e>>>=0,e^=e<<5,e>>>=0,e>>>0}return{next(){return(n()>>>0)/4294967295},nextRange(i,s){return i+(s-i)*((n()>>>0)/4294967295)},nextInt(i,s){return Math.floor(j.mix(n())%(s-i+1))+i},get state(){return e>>>0}}}function he(t,e){let n=t>>>0^2654435769;for(let i=0;i<e.length;i++)n^=e.charCodeAt(i)+114007148193232e5+(n<<6)+(n>>>2),n>>>=0;return n>>>0}class je{constructor(e,n,i,s=0,r=null){this.level=e,this.levelIndex=s,this.allLevels=r,this.world=n,this.api=i,this.time=0,this.done=!1,this.stageIndex=0,this.phaseStates=[],this.rng=j(e.seed>>>0),this.stageGateSpawned=!1,this._initStage()}_initStage(){const e=this.level.stages[this.stageIndex];this.stageGateSpawned=!1,this.phaseStates=e.phases.map((n,i)=>({id:n.id,t:0,cursor:0,asleepUntil:0,done:!1,rng:j(he(this.level.seed,n.id+":"+i))}))}update(e){var r,c;if(this.done)return;const n=this.level.stages[this.stageIndex];this.time+=e;for(let p=0;p<this.phaseStates.length;p++){const a=this.phaseStates[p];if(a.done)continue;a.t+=e;const y=n.phases[p].actions;if(!(a.asleepUntil>this.time)){for(;a.cursor<y.length;){const u=y[a.cursor];if(u.type==="sleep"){a.asleepUntil=this.time+(u.duration||0),a.cursor++;break}else if(u.type==="spawn"){const f=this.time,S=u.pattern||"burst",l=u.lane||"topRandom";(!a.spawn||a.spawn.index!==a.cursor)&&(a.spawn={index:a.cursor,startedAt:f,emitted:0,nextAt:f});const h=a.spawn;if(S==="burst"){const d=u.count|0;for(let m=0;m<d;m++)this.api.spawnEnemyById(u.enemy,{lane:l,rng:a.rng});a.cursor++,a.spawn=null;continue}if(S==="streamLinear"){const d=u.duration||0,m=u.rate||0,A=f-h.startedAt;if(m>0){let M=0;for(;f>=h.nextAt&&M<1e3;)this.api.spawnEnemyById(u.enemy,{lane:l,rng:a.rng}),h.emitted++,h.nextAt+=1/m,M++}A>=d&&(a.cursor++,a.spawn=null);break}if(S==="streamRamping"){const d=u.duration||0,m=((r=u.rate)==null?void 0:r.base)||0,A=((c=u.rate)==null?void 0:c.slope)||0,M=f-h.startedAt,g=v=>Math.max(1e-4,m+A*v);let w=0;for(;f>=h.nextAt&&M<d&&w<2e3;){this.api.spawnEnemyById(u.enemy,{lane:l,rng:a.rng}),h.emitted++;const v=h.nextAt-h.startedAt,K=g(v);h.nextAt+=1/K,w++}M>=d&&(a.cursor++,a.spawn=null);break}a.cursor++,a.spawn=null}else a.cursor++}a.cursor>=y.length&&!a.spawn&&(a.done=!0)}}const i=this.phaseStates.every(p=>p.done),s=n.miniboss&&n.miniboss.id||n.boss&&n.boss.id||null;if(s&&this.stageGateSpawned&&!this.api.hasLivingById(s)){this.stageIndex+1<this.level.stages.length?(this.stageIndex++,this._initStage()):this.done=!0;return}i&&(s?this.stageGateSpawned||(this.api.spawnEnemyById(s,{lane:"topRandom",rng:j(he(this.level.seed,"gate:"+s))}),this.stageGateSpawned=!0):this.stageIndex+1<this.level.stages.length?(this.stageIndex++,this._initStage()):this.done=!0)}loadLevel(e){this.allLevels&&(this.levelIndex=e,this.level=this.allLevels[this.levelIndex],this.time=0,this.done=!1,this.stageIndex=0,this._initStage())}}class Be{constructor(e,n,i,s,r){this.world=e,this.entity=n,this.archetype=i,this.api=s,this.rng=r,this.nextFireAt=0,this.state={phase:"descend",pauseUntil:0,nextVxJitterAt:0,vxTarget:0},this.firePhaseIdx=0,this.firePhaseTime=0}update(e,n,i){var p,a,y,u,f,S,l,h,d,m,A,M,g,w,v,K,re,q;const s=this.entity,r=(p=this.archetype)==null?void 0:p.movement,c=r==null?void 0:r.use;if(c==="popcornDrift"){const P=-(((a=r.params)==null?void 0:a.vy)||100);if(n>=this.state.nextVxJitterAt){const E=((y=r.params)==null?void 0:y.vxJitter)||60;this.state.vxTarget=(Math.random()*2-1)*E,this.state.nextVxJitterAt=n+(((u=r.params)==null?void 0:u.vxChangeEvery)||.7)}s.vx+=(this.state.vxTarget-s.vx)*Math.min(1,e*2),s.vy=P}else if(c==="gunshipSweep"){const P=((f=r.params)==null?void 0:f.yTopRatio)||.85,E=-this.world.height+2*this.world.height*P,O=3;s.vy=(E-s.y)*O;const V=20;s.y>this.world.height-V&&(s.y=this.world.height-V),s.y<-this.world.height+V&&(s.y=-this.world.height+V)}else if(c==="bursterStopAndBurst"){const P=-(((S=r.params)==null?void 0:S.vy)||60),E=((l=r.params)==null?void 0:l.stopYRatio)||.3,O=this.world.height*(E-1);this.state.phase==="descend"?(s.vy=P,s.y<=O&&(this.state.phase="pause",this.state.pauseUntil=n+(((h=r.params)==null?void 0:h.stopDuration)||2),s.vy=0,(m=(d=this.archetype)==null?void 0:d.fire)!=null&&m.onPauseOnly&&this.archetype.fire.shot&&this.api.fireShot(this.archetype.fire.shot,{x:s.x,y:s.y},{target:i},this.rng))):this.state.phase==="pause"?(s.vy=0,n>=this.state.pauseUntil&&(this.state.phase="resume")):s.vy=-(((A=r.params)==null?void 0:A.resumeVy)||P)}else if(c==="hoverTopBand"){s._hoverStartTime==null&&(s._hoverStartTime=n,s._hoverBaseX=s.x);const P=((M=r.params)==null?void 0:M.yRatio)||.8,E=-this.world.height+2*this.world.height*P,O=3;s.vy=(E-s.y)*O;const V=Math.min(((g=r.params)==null?void 0:g.sineXAmplitude)||80,this.world.width-40),Q=((w=r.params)==null?void 0:w.sineXFreqHz)||.25,ue=V*Math.sin(2*Math.PI*Q*(n-s._hoverStartTime));s.vx=0,s.x=(s._hoverBaseX||0)+ue;const _=20;s.x>this.world.width-_&&(s.x=this.world.width-_),s.x<-this.world.width+_&&(s.x=-this.world.width+_),s.y>this.world.height-_&&(s.y=this.world.height-_),s.y<-this.world.height+_&&(s.y=-this.world.height+_)}if((K=(v=this.archetype)==null?void 0:v.fire)!=null&&K.rate&&n>=this.nextFireAt){const P=this.archetype.fire.shot;this._fireWithFx(P,i),this.nextFireAt=n+1/this.archetype.fire.rate}if(Array.isArray((re=this.archetype)==null?void 0:re.firePhases)&&this.archetype.firePhases.length>0){const P=this.entity,E=this.archetype.firePhases,O=(P._maxHp||P.hp)>0?P.hp/(P._maxHp||P.hp):0;if(E.some(_=>_.untilHpRatio!=null))for(let _=0;_<E.length;_++){const k=E[_];if(k.untilHpRatio!=null&&O>k.untilHpRatio){this.firePhaseIdx=_;break}if(k.untilHpRatio!=null&&O<=k.untilHpRatio){this.firePhaseIdx=_;break}}else{this.firePhaseTime+=e;let _=0;for(let k=0;k<E.length;k++){if(_+=E[k].duration||5,this.firePhaseTime<=_){this.firePhaseIdx=k;break}k===E.length-1&&this.firePhaseTime>_&&(this.firePhaseTime=0,this.firePhaseIdx=0)}}const Q=E[this.firePhaseIdx]||E[0],ue=Q.rate?1/Q.rate:.3;if(n>=this.nextFireAt){const _=Q.shot||((q=this.archetype.fire)==null?void 0:q.shot);this._fireWithFx(_,i),this.nextFireAt=n+ue}}}_fireWithFx(e,n){var r,c,p,a,y;const i=this.entity,s=(r=this.archetype)==null?void 0:r.onFireFx;if((s==null?void 0:s.use)==="onFireWindupShake"){const u=((c=s.params)==null?void 0:c.windupMs)||120,f=((p=s.params)==null?void 0:p.shakeMs)||160,S=((a=s.params)==null?void 0:a.windupBackPx)||6,l=performance.now();i.fxWindupEndMs=l+u,i.fxWindupBackPx=S,i.fxShakeEndMs=l+u+f,i.fxShakePx=((y=s.params)==null?void 0:y.shakePx)||3}this.api.fireShot(e,{x:i.x,y:i.y},{target:n},this.rng)}}const b={world:{playerLives:9999,playerInvincibleMs:4e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,frictionPerSec:3,scrollImpulse:40,autoFireInterval:.02,autoBulletSpeed:300,spray:{count:10,spreadDeg:34}},enemy:{body:{w:18,h:22},speedMin:40,speedMax:70,fireInterval:.2,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.3,minInterval:.01,accelPerSec:.06},hp:1},bullets:{size:{w:6,h:10}},quadtree:{capacity:8,maxDepth:7},scoring:{enemyKillBase:10,comboMax:9,highScoreKey:"bh_highscore"},ui:{showPerfOverlay:!0,perfOffsetTopPx:8}};Le.setupViewport();ge.init();const X=document.getElementById("glcanvas"),ee=Te(X),o=He();o.player.x=0;o.player.y=-o.height+b.world.bottomYOffsetPx;o.player.lives=b.world.playerLives;const I=document.createElement("div");I.style.position="fixed";I.style.left="8px";I.style.top=String(b.ui.perfOffsetTopPx)+"px";I.style.padding="4px 6px";I.style.background="rgba(0,0,0,0.5)";I.style.color="#0f0";I.style.fontFamily="monospace";I.style.fontSize="12px";I.style.zIndex="1000";I.style.pointerEvents="auto";I.style.whiteSpace="pre";let te=!0;document.body.appendChild(I);I.addEventListener("click",()=>{te=!te,I.style.opacity=te?"1":"0"});I.style.opacity=te?"1":"0";const F=document.createElement("div");F.style.position="fixed";F.style.right="8px";F.style.top="8px";F.style.padding="4px 6px";F.style.background="rgba(0,0,0,0.5)";F.style.color="#0f0";F.style.fontFamily="monospace";F.style.fontSize="12px";F.style.zIndex="1000";F.style.pointerEvents="none";F.style.whiteSpace="pre";F.style.textAlign="right";document.body.appendChild(F);const B=document.createElement("div");B.style.position="fixed";B.style.left="50%";B.style.top="8px";B.style.transform="translateX(-50%)";B.style.width="60%";B.style.height="10px";B.style.background="rgba(255,255,255,0.1)";B.style.border="1px solid rgba(255,255,255,0.3)";B.style.borderRadius="6px";B.style.overflow="hidden";B.style.zIndex="1000";B.setAttribute("data-testid","boss-hp-bar");const ie=document.createElement("div");ie.style.height="100%";ie.style.width="0%";ie.style.background="linear-gradient(90deg, #f44, #f8a)";B.appendChild(ie);document.body.appendChild(B);B.style.display="none";const x=document.createElement("div");x.style.position="fixed";x.style.left="50%";x.style.top="50%";x.style.transform="translate(-50%, -50%)";x.style.background="rgba(0,0,0,0.7)";x.style.color="#fff";x.style.padding="16px 20px";x.style.border="1px solid rgba(255,255,255,0.25)";x.style.borderRadius="8px";x.style.fontFamily="monospace";x.style.fontSize="14px";x.style.zIndex="1200";x.style.textAlign="center";x.style.whiteSpace="pre";x.setAttribute("data-testid","level-complete");x.style.display="none";document.body.appendChild(x);const W=document.createElement("button");W.textContent="Continue";W.style.marginTop="8px";W.style.padding="6px 10px";W.style.fontFamily="monospace";W.style.fontSize="14px";W.style.cursor="pointer";W.addEventListener("click",()=>{z.levelIndex+1<Z.length?(z.loadLevel(z.levelIndex+1),x.style.display="none"):showWin()});x.appendChild(document.createElement("br"));x.appendChild(W);const Ze=1e3;let $=[],oe=0,we=performance.now(),ce=!0;const T=new Set;window.addEventListener("keydown",t=>{T.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{T.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let le=!1;ge.on("sideButton",()=>{le=!0});ge.on("scrollWheel",({direction:t})=>{if(!o.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===be&&n-ve<Qe?me+=1:me=1,ve=n,be=i,H+=i*me*et});let fe=0;const se=new WeakMap,Pe=new Je({fireEnemyBullet:(t,e,n,i,s,r)=>Ve(o,t,e,n,i,s,r)}),z=new je(Z[0],o,{spawnEnemyById:(t,{lane:e,rng:n})=>Ee(t,e,n),hasLivingById:t=>{for(let e=0;e<o.enemies.length;e++)if(o.enemies[e]._enemyId===t)return!0;return!1}},0,Z);function Ee(t,e,n){var u,f,S,l,h,d;const i=J[t];if(!i)return;const s=30;let r=0,c=o.height+s;e==="topRandom"||!e?(r=(n&&typeof n.next=="function"?n.next()*2-1:Math.random()*2-1)*(o.width-20),c=o.height+s):e==="topLeftRightOffscreen"&&(r=(n&&typeof n.next=="function"?n.next():Math.random())<.5?-o.width-s:o.width+s,c=o.height-20);let p=-80;((u=i.movement)==null?void 0:u.use)==="gunshipSweep"&&(p=0),((f=i.movement)==null?void 0:f.use)==="bursterStopAndBurst"&&(p=-60),((S=i.movement)==null?void 0:S.use)==="popcornDrift"&&(p=-100),Oe(o,r,c,p);const a=o.enemies[o.enemies.length-1];if(!a)return;a._enemyId=t,a._maxHp=i.hp!=null?i.hp:a.hp,i.size&&(a.w=i.size.w,a.h=i.size.h),i.hp!=null&&(a.hp=i.hp),((l=i.movement)==null?void 0:l.use)==="gunshipSweep"&&(a.vx=r<0?Math.abs(((h=i.movement.params)==null?void 0:h.vx)||70):-Math.abs(((d=i.movement.params)==null?void 0:d.vx)||70));const y=new Be(o,a,i,{fireShot:(m,A,M,g)=>Pe.emit(m,A,M,g)},j(he(n&&n.state?n.state:1,t+":"+String(o.enemies.length))));se.set(a,y)}let C=0,U=0,R=0,ae=0,ye=0;try{R=parseInt(localStorage.getItem(b.scoring.highScoreKey)||"0",10)||0}catch{R=0}function D(t){return String((t|0)<0?0:t|0).padStart(8,"0")}let H=0,ve=0,be=0,me=1;const Qe=2e3,et=b.player.scrollImpulse,tt=b.player.keyAccel,Se=b.player.maxKeySpeed,pe=ee.floatsPerInstance;let ne=16384,L=new Float32Array(ne*pe),G=0;function st(t){if(t<=ne)return;let e=ne;for(;e<t;)e*=2;const n=new Float32Array(e*pe);n.set(L.subarray(0,G*pe)),L=n,ne=e}function N(t,e,n,i,s,r,c,p){G+1>ne&&st(G+1);const a=G*pe;L[a]=t,L[a+1]=e,L[a+2]=n,L[a+3]=i,L[a+4]=s,L[a+5]=r,L[a+6]=c,L[a+7]=p,G++}function Ae(t,e,n,i,s,r,c,p){return!(t+n*.5<s-c*.5||s+c*.5<t-n*.5||e+i*.5<r-p*.5||r+p*.5<e-i*.5)}function Me(t){var S;const{width:e,height:n}=ee.resize();o.width=e*.5,o.height=n*.5,window.__debug&&(window.__debug.frameCount=(window.__debug.frameCount|0)+1);const i=t-we;for(we=t,$.push(i),oe+=i;oe>Ze&&$.length>0;)oe-=$.shift();if($.length>0&&te){const l=$.length,h=oe/l,d=1e3/Math.max(1e-4,h),m=$.map(g=>1e3/Math.max(1e-4,g)).sort((g,w)=>g-w),A=Math.max(0,Math.floor(.01*l)),M=m[A];I.textContent=`fps ${d.toFixed(1)}
1% ${M.toFixed(1)}
vsync ${ce?"on":"off"}`}F.textContent=`score ${D(C)}
hi ${D(R)}`;const s=Math.max(0,Math.min(1/Math.max(1,$e.fpsCap),i*.001)),r=o.player,c=b.player.moveSpeedY;let p=0,a=0;if((T.has("arrowleft")||T.has("a"))&&(p-=1),(T.has("arrowright")||T.has("d"))&&(p+=1),(T.has("arrowup")||T.has("w"))&&(a-=1),(T.has("arrowdown")||T.has("s"))&&(a+=1),a!==0){const l=a/Math.abs(a);r.y+=l*c*s}if(p!==0){const l=p/Math.abs(p);H+=l*tt*s,Math.abs(H)>Se&&(H=Math.sign(H)*Se)}const y=Math.exp(-3*s);H*=y,r.x+=H*s,Ye(o),o.time===0&&(r.x=0,r.y=-o.height+b.world.bottomYOffsetPx),z.update(s);for(let l=0;l<o.enemies.length;l++){const h=o.enemies[l];let d=se.get(h);!d&&h._enemyId&&J[h._enemyId]&&(d=new Be(o,h,J[h._enemyId],{fireShot:(m,A,M,g)=>Pe.emit(m,A,M,g)},null),se.set(h,d)),d&&d.update(s,o.time,o.player)}if(fe-=s,r.alive&&fe<=0){const l=Math.max(1,b.player.spray.count|0),h=b.player.spray.spreadDeg*Math.PI/180,m=Math.PI/2-h/2,A=l>1?h/(l-1):0;for(let M=0;M<l;M++){const g=m+A*M,w=Math.cos(g),v=Math.sin(g);qe(o,r.x,r.y+12,w,v,b.player.autoBulletSpeed)}fe=b.player.autoFireInterval}Ue(o,s),!r.alive&&r.lives<=0?le&&(o.time=0,o.enemies.length=0,o.playerBullets.length=0,Ge(o),r.x=0,r.y=-o.height+b.world.bottomYOffsetPx,r.alive=!0,r.lives=b.world.playerLives,r.invincibleUntil=performance.now()+b.world.playerInvincibleMs,H=0,C=0,U=0,le=!1):le=!1,!r.alive&&r.lives<=0?(x.textContent=`GAME OVER

score ${D(C)}
hi ${D(R)}
combo_peak ${D(ae)}
misses ${D(ye)}`,x.style.display="block",W.style.display="none"):W.style.display="inline-block";const u=new ze({x:-o.width,y:-o.height,w:o.width*2,h:o.height*2},8,7);for(let l=0;l<o.enemies.length;l++){const h=o.enemies[l];u.insertRect(h.x-h.w*.5,h.y-h.h*.5,h.w,h.h,l)}for(let l=0;l<o.playerBullets.length;l++){const h=o.playerBullets[l],d=h.x-h.w*.5,m=h.y-h.h*.5,A=u.queryRect(d,m,h.w,h.h,[]);let M=!1;for(let g=0;g<A.length;g++){const w=A[g].ref,v=o.enemies[w];if(v&&Ae(h.x,h.y,h.w,h.h,v.x,v.y,v.w,v.h)){if(v.hp-=1,o.playerBullets[l]=o.playerBullets[o.playerBullets.length-1],o.playerBullets.pop(),l--,M=!0,v.hp<=0){U=Math.min(b.scoring.comboMax,U+1),U>ae&&(ae=U);const K=b.scoring.enemyKillBase*Math.max(1,U)|0;if(C+=K,C>R){R=C;try{localStorage.setItem(b.scoring.highScoreKey,String(R))}catch{}}try{se.delete(v)}catch{}o.enemies[w]=o.enemies[o.enemies.length-1],o.enemies.pop();const re=Math.random()<.8?1:0;for(let q=0;q<re;q++)o.coins.push({x:v.x,y:v.y,speed:240})}break}}}if(o.player.alive){for(let l=0;l<o.enemyBullets.length;l++){const h=o.enemyBullets[l];if(!(performance.now()<r.invincibleUntil)&&Ae(o.player.x,o.player.y,1,1,h.x,h.y,h.w,h.h)){r.lives-=1,ye+=1,U=0,r.lives>0?(r.x=0,r.y=-o.height+b.world.bottomYOffsetPx,r.invincibleUntil=performance.now()+b.world.playerInvincibleMs,Ke(o,r.x,r.y,32),H=0):(r.alive=!1,typeof navigator<"u"&&navigator.vibrate&&navigator.vibrate(200));break}}for(let l=0;l<o.coins.length;l++){const h=o.coins[l];if(Math.hypot(h.x-r.x,h.y-r.y)<12){if(C+=5,C>R){R=C;try{localStorage.setItem(b.scoring.highScoreKey,String(R))}catch{}}o.coins[l]=o.coins[o.coins.length-1],o.coins.pop(),l--}}for(let l=0;l<o.powerups.length;l++){const h=o.powerups[l];Math.hypot(h.x-r.x,h.y-r.y)<14&&(b.player.spray.count=Math.min(20,(b.player.spray.count|0)+5),o.powerups[l]=o.powerups[o.powerups.length-1],o.powerups.pop(),l--)}}G=0,ee.beginFrame(),r.alive&&(!(performance.now()<r.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&N(r.x,r.y,14,18,0,.2,.9,1);for(let l=0;l<o.enemies.length;l++){const h=o.enemies[l];let d=0,m=0;const A=performance.now();h.fxWindupEndMs&&A<h.fxWindupEndMs?m-=h.fxWindupBackPx||0:h.fxShakeEndMs&&A<h.fxShakeEndMs&&(d+=(Math.random()*2-1)*(h.fxShakePx||0),m+=(Math.random()*2-1)*(h.fxShakePx||0)),N(h.x+d,h.y+m,18,22,Math.PI,1,.3,.3)}for(let l=0;l<o.playerBullets.length;l++){const h=o.playerBullets[l],d=Math.atan2(h.vy,h.vx)-Math.PI*.5;N(h.x,h.y,6,10,d,1,1,.4)}for(let l=0;l<o.enemyBullets.length;l++){const h=o.enemyBullets[l],d=Math.atan2(h.vy,h.vx)-Math.PI*.5;N(h.x,h.y,6,10,d,1,.4,1)}for(let l=0;l<o.coins.length;l++){const h=o.coins[l];N(h.x,h.y,8,8,0,1,.84,.2)}for(let l=0;l<o.powerups.length;l++){const h=o.powerups[l];N(h.x,h.y,14,14,Math.PI/4,.7,.4,1)}ee.setInstances(L,G),ee.draw();let f=null;for(let l=0;l<o.enemies.length;l++){const h=o.enemies[l],d=h._enemyId;if(d&&((S=J[d])!=null&&S.boss)){f=h;break}}if(f&&f._maxHp>0){B.style.display="block";const l=Math.max(0,Math.min(1,f.hp/f._maxHp));ie.style.width=String(Math.floor(l*100))+"%"}else B.style.display="none";z.done&&!f?x.style.display!=="block"&&(x.textContent=`LEVEL COMPLETE

score ${D(C)}
hi ${D(R)}
combo_peak ${D(ae)}
misses ${D(ye)}`,x.style.display="block"):x.style.display="none",Ie()}function nt(){X.style.width||(X.style.width="100vw"),X.style.height||(X.style.height="100vh"),X.style.display="block"}nt();Ie();function Ie(){ce?requestAnimationFrame(Me):setTimeout(()=>Me(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(ce=!ce)});window.__debug=window.__debug||{};window.__debug.enemiesSummary=()=>({count:o.enemies.length,types:o.enemies.reduce((t,e)=>{const n=e._enemyId||"unknown";return t[n]=(t[n]||0)+1,t},{})});window.__debug.bulletsSummary=()=>({player:o.playerBullets.length,enemy:o.enemyBullets.length});window.__debug.frameCount=0;window.__debug.getBossInfo=()=>{var t;for(let e=0;e<o.enemies.length;e++){const n=o.enemies[e],i=n._enemyId;if(i&&((t=J[i])!=null&&t.boss))return{id:i,hp:n.hp,maxHp:n._maxHp||n.hp}}return null};window.__debug.damageBoss=(t=10)=>{var e;for(let n=0;n<o.enemies.length;n++){const i=o.enemies[n],s=i._enemyId;if(s&&((e=J[s])!=null&&e.boss)){if(i.hp-=t,i.hp<=0){try{se.delete(i)}catch{}o.enemies[n]=o.enemies[o.enemies.length-1],o.enemies.pop()}return!0}}return!1};window.__debug.forceSpawnGate=()=>{const t=Z[0].stages[z.stageIndex],e=t.miniboss&&t.miniboss.id||t.boss&&t.boss.id;if(e){Ee(e,"topRandom",j(he(Z[0].seed,"forceGate")));try{z.stageGateSpawned=!0}catch{}return!0}return!1};window.__debug.setStage=t=>{if(typeof t!="number")return!1;const e=Z[0].stages.length-1,n=Math.max(0,Math.min(e,t));return z.stageIndex=n,z._initStage&&z._initStage(),!0};
