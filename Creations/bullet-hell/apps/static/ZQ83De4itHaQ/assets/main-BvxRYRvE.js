(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const s of l)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(l){const s={};return l.integrity&&(s.integrity=l.integrity),l.referrerPolicy&&(s.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?s.credentials="include":l.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(l){if(l.ep)return;l.ep=!0;const s=n(l);fetch(l.href,s)}})();class ie{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],l=i.indexOf(n);l>-1&&i.splice(l,1)}}const $=new ie;class se{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const re=new se;function G(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function le(t,e,n){const i=G(t,t.VERTEX_SHADER,e),l=G(t,t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,i),t.attachShader(s,l),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const oe=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,ae=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function ce(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=le(e,oe,ae);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),l=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,l,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const c=8;let y=512,d=0,M=new Float32Array(y*c);const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,M.byteLength,e.DYNAMIC_DRAW);const o=c*4;let f=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(1,1),f+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,o,f),e.vertexAttribDivisor(2,1),f+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,o,f),e.vertexAttribDivisor(3,1),f+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,o,f),e.vertexAttribDivisor(4,1);function w(p){if(p<=y)return;let m=y;for(;m<p;)m*=2;const L=new Float32Array(m*c);L.set(M.subarray(0,d*c)),M=L,y=m,e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,M.byteLength,e.DYNAMIC_DRAW)}function b(){const p=Math.min(window.devicePixelRatio||1,2),m=Math.floor(t.clientWidth*p),L=Math.floor(t.clientHeight*p);return(t.width!==m||t.height!==L)&&(t.width=m,t.height=L),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:p}}function S(){e.clear(e.COLOR_BUFFER_BIT)}function g(p,m){w(m),d=m,M.set(p.subarray(0,m*c),0),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferSubData(e.ARRAY_BUFFER,0,M.subarray(0,m*c))}function P(){d!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,d))}return{gl:e,floatsPerInstance:c,resize:b,beginFrame:S,setInstances:g,draw:P}}function z(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class F{constructor(e,n,i,l){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=l,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:l}=this.bounds,s=i*.5,u=l*.5,c=this.depth+1,y=this.capacity,d=this.maxDepth;this.children=[new F({x:e,y:n,w:s,h:u},y,c,d),new F({x:e+s,y:n,w:s,h:u},y,c,d),new F({x:e,y:n+u,w:s,h:u},y,c,d),new F({x:e+s,y:n+u,w:s,h:u},y,c,d)]}insert(e){if(!z(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let l=!1;for(let s=0;s<4;s++)if(this.children[s].insert(i)){l=!0;break}l?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!z(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const l=this.items[i];z(e,l)&&n.push(l)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class he{constructor(e,n=16,i=8){this.root=new F(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new F(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,l,s){const u={x:e,y:n,w:i,h:l,ref:s};this.root.insert(u)}queryRect(e,n,i,l,s=[]){return this.root.query({x:e,y:n,w:i,h:l},s)}}const ue=1e4;function ye(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[],enemyBulletPool:(()=>{const t=[];for(let e=0;e<ue;e++)t.push({x:0,y:0,vx:0,vy:0,w:4,h:8});return t})()}}function fe(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function pe(t,e,n,i=0,l=-1,s=240){const u=Math.max(1e-4,Math.hypot(i,l));t.playerBullets.push({x:e,y:n,vx:i/u*s,vy:l/u*s,w:4,h:8})}function de(t,e,n,i=0,l=1,s=160){const u=Math.max(1e-4,Math.hypot(i,l)),c=t.enemyBulletPool.length>0?t.enemyBulletPool.pop():null;c&&(c.x=e,c.y=n,c.vx=i/u*s,c.vy=l/u*s,t.enemyBullets.push(c))}function me(t,e){t.time+=e;for(let n=0;n<t.playerBullets.length;n++){const i=t.playerBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.playerBullets[n]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),n--)}for(let n=0;n<t.enemyBullets.length;n++){const i=t.enemyBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.enemyBullets[n]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),t.enemyBulletPool.push(i),n--)}for(let n=0;n<t.enemies.length;n++){const i=t.enemies[n];i.x+=i.vx*e,i.y+=i.vy*e,i.y>t.height+40&&(t.enemies[n]=t.enemies[t.enemies.length-1],t.enemies.pop(),n--)}}function xe(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}function ve(t){for(let e=0;e<t.enemyBullets.length;e++)t.enemyBulletPool.push(t.enemyBullets[e]);t.enemyBullets.length=0}function be(t,e,n,i){const l=i*i;let s=0;for(let u=0;u<t.enemyBullets.length;u++){const c=t.enemyBullets[u],y=c.x-e,d=c.y-n;y*y+d*d<=l?t.enemyBulletPool.push(c):t.enemyBullets[s++]=c}t.enemyBullets.length=s}const h={world:{playerLives:3,playerInvincibleMs:4e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,frictionPerSec:3,scrollImpulse:40,autoFireInterval:.02,autoBulletSpeed:300,spray:{count:10,spreadDeg:34}},enemy:{body:{w:18,h:22},speedMin:40,speedMax:70,fireInterval:.2,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.3,minInterval:.01,accelPerSec:.06},hp:1},bullets:{size:{w:6,h:10}},quadtree:{capacity:8,maxDepth:7},scoring:{enemyKillBase:10,comboMax:9,highScoreKey:"bh_highscore"},ui:{showPerfOverlay:!0,perfOffsetTopPx:8}};re.setupViewport();$.init();const R=document.getElementById("glcanvas"),O=ce(R),r=ye();r.player.x=0;r.player.y=-r.height+h.world.bottomYOffsetPx;r.player.lives=h.world.playerLives;const v=document.createElement("div");v.style.position="fixed";v.style.left="8px";v.style.top=String(h.ui.perfOffsetTopPx)+"px";v.style.padding="4px 6px";v.style.background="rgba(0,0,0,0.5)";v.style.color="#0f0";v.style.fontFamily="monospace";v.style.fontSize="12px";v.style.zIndex="1000";v.style.pointerEvents="none";v.style.whiteSpace="pre";document.body.appendChild(v);const x=document.createElement("div");x.style.position="fixed";x.style.right="8px";x.style.top="8px";x.style.padding="4px 6px";x.style.background="rgba(0,0,0,0.5)";x.style.color="#0f0";x.style.fontFamily="monospace";x.style.fontSize="12px";x.style.zIndex="1000";x.style.pointerEvents="none";x.style.whiteSpace="pre";x.style.textAlign="right";document.body.appendChild(x);const ge=1e3;let I=[],T=0,X=performance.now(),q=!1;const A=new Set;window.addEventListener("keydown",t=>{A.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{A.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let Y=!1;$.on("sideButton",()=>{Y=!0});$.on("scrollWheel",({direction:t})=>{if(!r.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===J&&n-j<we?H+=1:H=1,j=n,J=i,E+=i*H*Be});let U=0,N=0,D=0,k=0,C=0;try{C=parseInt(localStorage.getItem(h.scoring.highScoreKey)||"0",10)||0}catch{C=0}function Z(t){return String((t|0)<0?0:t|0).padStart(8,"0")}let E=0,j=0,J=0,H=1;const we=2e3,Be=h.player.scrollImpulse,Se=h.player.keyAccel,Q=h.player.maxKeySpeed,K=O.floatsPerInstance;let W=16384,B=new Float32Array(W*K),_=0;function Ae(t){if(t<=W)return;let e=W;for(;e<t;)e*=2;const n=new Float32Array(e*K);n.set(B.subarray(0,_*K)),B=n,W=e}function V(t,e,n,i,l,s,u,c){_+1>W&&Ae(_+1);const y=_*K;B[y]=t,B[y+1]=e,B[y+2]=n,B[y+3]=i,B[y+4]=l,B[y+5]=s,B[y+6]=u,B[y+7]=c,_++}function ee(t,e,n,i,l,s,u,c){return!(t+n*.5<l-u*.5||l+u*.5<t-n*.5||e+i*.5<s-c*.5||s+c*.5<e-i*.5)}function te(t){const{width:e,height:n}=O.resize();r.width=e*.5,r.height=n*.5;const i=t-X;for(X=t,I.push(i),T+=i;T>ge&&I.length>0;)T-=I.shift();if(I.length>0&&h.ui.showPerfOverlay){const a=I.length,o=T/a,f=1e3/Math.max(1e-4,o),w=I.map(g=>1e3/Math.max(1e-4,g)).sort((g,P)=>g-P),b=Math.max(0,Math.floor(.01*a)),S=w[b];v.textContent=`fps ${f.toFixed(1)}
1% ${S.toFixed(1)}
vsync ${q?"on":"off"}`}x.textContent=`score ${Z(D)}
hi ${Z(C)}`;const l=Math.max(0,Math.min(.05,i*.001)),s=r.player,u=h.player.moveSpeedY;let c=0,y=0;if((A.has("arrowleft")||A.has("a"))&&(c-=1),(A.has("arrowright")||A.has("d"))&&(c+=1),(A.has("arrowup")||A.has("w"))&&(y-=1),(A.has("arrowdown")||A.has("s"))&&(y+=1),y!==0){const a=y/Math.abs(y);s.y+=a*u*l}if(c!==0){const a=c/Math.abs(c);E+=a*Se*l,Math.abs(E)>Q&&(E=Math.sign(E)*Q)}const d=Math.exp(-3*l);if(E*=d,s.x+=E*l,xe(r),r.time===0&&(s.x=0,s.y=-r.height+h.world.bottomYOffsetPx),U-=l,U<=0){const a=(Math.random()*2-1)*(r.width-20),o=-(h.enemy.speedMin+Math.random()*(h.enemy.speedMax-h.enemy.speedMin));fe(r,a,r.height-20,o);const f=r.enemies[r.enemies.length-1];f&&(f.nextFireAt=r.time+Math.random()*h.enemy.fireInterval);const w=h.enemy.spawn.baseInterval,b=h.enemy.spawn.accelPerSec*r.time;U=Math.max(h.enemy.spawn.minInterval,w-b)}if(s.alive)for(let a=0;a<r.enemies.length;a++){const o=r.enemies[a];if(o.nextFireAt==null&&(o.nextFireAt=r.time+Math.random()*h.enemy.fireInterval),r.time>=o.nextFireAt){const f=s.x-o.x,w=s.y-o.y,b=h.enemy.bulletSpeedMin+Math.random()*(h.enemy.bulletSpeedMax-h.enemy.bulletSpeedMin);de(r,o.x,o.y,f,w,b),o.nextFireAt=r.time+h.enemy.fireInterval}}if(N-=l,s.alive&&N<=0){const a=Math.max(1,h.player.spray.count|0),o=h.player.spray.spreadDeg*Math.PI/180,w=Math.PI/2-o/2,b=a>1?o/(a-1):0;for(let S=0;S<a;S++){const g=w+b*S,P=Math.cos(g),p=Math.sin(g);pe(r,s.x,s.y+12,P,p,h.player.autoBulletSpeed)}N=h.player.autoFireInterval}me(r,l),!s.alive&&s.lives<=0?Y&&(r.time=0,r.enemies.length=0,r.playerBullets.length=0,ve(r),s.x=0,s.y=-r.height+h.world.bottomYOffsetPx,s.alive=!0,s.lives=h.world.playerLives,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,E=0,U=h.enemy.spawn.baseInterval,D=0,k=0,Y=!1):Y=!1;const M=new he({x:-r.width,y:-r.height,w:r.width*2,h:r.height*2},8,7);for(let a=0;a<r.enemies.length;a++){const o=r.enemies[a];M.insertRect(o.x-o.w*.5,o.y-o.h*.5,o.w,o.h,a)}for(let a=0;a<r.playerBullets.length;a++){const o=r.playerBullets[a],f=o.x-o.w*.5,w=o.y-o.h*.5,b=M.queryRect(f,w,o.w,o.h,[]);let S=!1;for(let g=0;g<b.length;g++){const P=b[g].ref,p=r.enemies[P];if(p&&ee(o.x,o.y,o.w,o.h,p.x,p.y,p.w,p.h)){if(p.hp-=1,r.playerBullets[a]=r.playerBullets[r.playerBullets.length-1],r.playerBullets.pop(),a--,S=!0,p.hp<=0){k=Math.min(h.scoring.comboMax,k+1);const m=h.scoring.enemyKillBase*Math.max(1,k)|0;if(D+=m,D>C){C=D;try{localStorage.setItem(h.scoring.highScoreKey,String(C))}catch{}}r.enemies[P]=r.enemies[r.enemies.length-1],r.enemies.pop()}break}}}if(r.player.alive)for(let a=0;a<r.enemyBullets.length;a++){const o=r.enemyBullets[a];if(!(performance.now()<s.invincibleUntil)&&ee(r.player.x,r.player.y,1,1,o.x,o.y,o.w,o.h)){s.lives-=1,k=0,s.lives>0?(s.x=0,s.y=-r.height+h.world.bottomYOffsetPx,s.invincibleUntil=performance.now()+h.world.playerInvincibleMs,be(r,s.x,s.y,32),E=0):(s.alive=!1,typeof navigator<"u"&&navigator.vibrate&&navigator.vibrate(200));break}}_=0,O.beginFrame(),s.alive&&(!(performance.now()<s.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&V(s.x,s.y,14,18,0,.2,.9,1);for(let a=0;a<r.enemies.length;a++){const o=r.enemies[a];V(o.x,o.y,18,22,Math.PI,1,.3,.3)}for(let a=0;a<r.playerBullets.length;a++){const o=r.playerBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;V(o.x,o.y,6,10,f,1,1,.4)}for(let a=0;a<r.enemyBullets.length;a++){const o=r.enemyBullets[a],f=Math.atan2(o.vy,o.vx)-Math.PI*.5;V(o.x,o.y,6,10,f,1,.4,1)}O.setInstances(B,_),O.draw(),ne()}function Me(){R.style.width||(R.style.width="100vw"),R.style.height||(R.style.height="100vh"),R.style.display="block"}Me();ne();function ne(){q?requestAnimationFrame(te):setTimeout(()=>te(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(q=!q)});
