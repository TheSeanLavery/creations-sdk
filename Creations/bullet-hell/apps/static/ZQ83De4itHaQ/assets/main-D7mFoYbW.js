(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const h of s.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();class ie{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],o=i.indexOf(n);o>-1&&i.splice(o,1)}}const $=new ie;class se{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const re=new se;function G(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function oe(t,e,n){const i=G(t,t.VERTEX_SHADER,e),o=G(t,t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,i),t.attachShader(s,o),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const le=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,ae=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function ce(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=oe(e,le,ae);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),o=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const d=8;let u=512,w=0,B=new Float32Array(u*d);const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,B.byteLength,e.DYNAMIC_DRAW);const l=d*4;let y=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,l,y),e.vertexAttribDivisor(1,1),y+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,l,y),e.vertexAttribDivisor(2,1),y+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,l,y),e.vertexAttribDivisor(3,1),y+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,l,y),e.vertexAttribDivisor(4,1);function b(f){if(f<=u)return;let p=u;for(;p<f;)p*=2;const P=new Float32Array(p*d);P.set(B.subarray(0,w*d)),B=P,u=p,e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,B.byteLength,e.DYNAMIC_DRAW)}function E(){const f=Math.min(window.devicePixelRatio||1,2),p=Math.floor(t.clientWidth*f),P=Math.floor(t.clientHeight*f);return(t.width!==p||t.height!==P)&&(t.width=p,t.height=P),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:f}}function g(){e.clear(e.COLOR_BUFFER_BIT)}function v(f,p){b(p),w=p,B.set(f.subarray(0,p*d),0),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferSubData(e.ARRAY_BUFFER,0,B.subarray(0,p*d))}function _(){w!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,w))}return{gl:e,floatsPerInstance:d,resize:E,beginFrame:g,setInstances:v,draw:_}}function q(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class L{constructor(e,n,i,o){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=o,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:o}=this.bounds,s=i*.5,h=o*.5,d=this.depth+1,u=this.capacity,w=this.maxDepth;this.children=[new L({x:e,y:n,w:s,h},u,d,w),new L({x:e+s,y:n,w:s,h},u,d,w),new L({x:e,y:n+h,w:s,h},u,d,w),new L({x:e+s,y:n+h,w:s,h},u,d,w)]}insert(e){if(!q(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let o=!1;for(let s=0;s<4;s++)if(this.children[s].insert(i)){o=!0;break}o?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!q(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const o=this.items[i];q(e,o)&&n.push(o)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class he{constructor(e,n=16,i=8){this.root=new L(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new L(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,o,s){const h={x:e,y:n,w:i,h:o,ref:s};this.root.insert(h)}queryRect(e,n,i,o,s=[]){return this.root.query({x:e,y:n,w:i,h:o},s)}}function ue(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[]}}function de(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function ye(t,e,n,i=0,o=-1,s=240){const h=Math.max(1e-4,Math.hypot(i,o));t.playerBullets.push({x:e,y:n,vx:i/h*s,vy:o/h*s,w:4,h:8})}function fe(t,e,n,i=0,o=1,s=160){const h=Math.max(1e-4,Math.hypot(i,o));t.enemyBullets.push({x:e,y:n,vx:i/h*s,vy:o/h*s,w:4,h:8})}function pe(t,e){t.time+=e;for(let n=0;n<t.playerBullets.length;n++){const i=t.playerBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.playerBullets[n]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),n--)}for(let n=0;n<t.enemyBullets.length;n++){const i=t.enemyBullets[n];i.x+=i.vx*e,i.y+=i.vy*e,(i.x<-t.width||i.x>t.width||i.y<-t.height||i.y>t.height)&&(t.enemyBullets[n]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),n--)}for(let n=0;n<t.enemies.length;n++){const i=t.enemies[n];i.x+=i.vx*e,i.y+=i.vy*e,i.y>t.height+40&&(t.enemies[n]=t.enemies[t.enemies.length-1],t.enemies.pop(),n--)}}function me(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}const c={world:{playerLives:3,playerInvincibleMs:4e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,frictionPerSec:3,scrollImpulse:40,autoFireInterval:.09,autoBulletSpeed:300,spray:{count:5,spreadDeg:24}},enemy:{body:{w:18,h:22},speedMin:40,speedMax:70,fireInterval:.5,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.9,minInterval:.25,accelPerSec:.03},hp:3},bullets:{size:{w:6,h:10}},quadtree:{capacity:8,maxDepth:7},scoring:{enemyKillBase:10,comboMax:9,highScoreKey:"bh_highscore"},ui:{showPerfOverlay:!0,perfOffsetTopPx:8}};re.setupViewport();$.init();const F=document.getElementById("glcanvas"),k=ce(F),r=ue();r.player.x=0;r.player.y=-r.height+c.world.bottomYOffsetPx;r.player.lives=c.world.playerLives;const x=document.createElement("div");x.style.position="fixed";x.style.left="8px";x.style.top=String(c.ui.perfOffsetTopPx)+"px";x.style.padding="4px 6px";x.style.background="rgba(0,0,0,0.5)";x.style.color="#0f0";x.style.fontFamily="monospace";x.style.fontSize="12px";x.style.zIndex="1000";x.style.pointerEvents="none";x.style.whiteSpace="pre";document.body.appendChild(x);const m=document.createElement("div");m.style.position="fixed";m.style.right="8px";m.style.top="8px";m.style.padding="4px 6px";m.style.background="rgba(0,0,0,0.5)";m.style.color="#0f0";m.style.fontFamily="monospace";m.style.fontSize="12px";m.style.zIndex="1000";m.style.pointerEvents="none";m.style.whiteSpace="pre";m.style.textAlign="right";document.body.appendChild(m);const xe=1e3;let I=[],O=0,X=performance.now(),V=!1;const A=new Set;window.addEventListener("keydown",t=>{A.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{A.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let U=!1;$.on("sideButton",()=>{U=!0});$.on("scrollWheel",({direction:t})=>{if(!r.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===Z&&n-J<ve?N+=1:N=1,J=n,Z=i,M+=i*N*we});let W=0,K=0,z=0,D=0,C=0,R=0;try{R=parseInt(localStorage.getItem(c.scoring.highScoreKey)||"0",10)||0}catch{R=0}function j(t){return String((t|0)<0?0:t|0).padStart(8,"0")}let M=0,J=0,Z=0,N=1;const ve=2e3,we=c.player.scrollImpulse,be=c.player.keyAccel,Q=c.player.maxKeySpeed,ge=16384,H=k.floatsPerInstance;let S=new Float32Array(ge*H),Y=0;function T(t,e,n,i,o,s,h,d){const u=Y*H;u+H>S.length||(S[u]=t,S[u+1]=e,S[u+2]=n,S[u+3]=i,S[u+4]=o,S[u+5]=s,S[u+6]=h,S[u+7]=d,Y++)}function ee(t,e,n,i,o,s,h,d){return!(t+n*.5<o-h*.5||o+h*.5<t-n*.5||e+i*.5<s-d*.5||s+d*.5<e-i*.5)}function te(t){const{width:e,height:n}=k.resize();r.width=e*.5,r.height=n*.5;const i=t-X;for(X=t,I.push(i),O+=i;O>xe&&I.length>0;)O-=I.shift();if(I.length>0&&c.ui.showPerfOverlay){const a=I.length,l=O/a,y=1e3/Math.max(1e-4,l),b=I.map(v=>1e3/Math.max(1e-4,v)).sort((v,_)=>v-_),E=Math.max(0,Math.floor(.01*a)),g=b[E];x.textContent=`fps ${y.toFixed(1)}
1% ${g.toFixed(1)}
vsync ${V?"on":"off"}`}m.textContent=`score ${j(D)}
hi ${j(R)}`;const o=Math.max(0,Math.min(.05,i*.001)),s=r.player,h=c.player.moveSpeedY;let d=0,u=0;if((A.has("arrowleft")||A.has("a"))&&(d-=1),(A.has("arrowright")||A.has("d"))&&(d+=1),(A.has("arrowup")||A.has("w"))&&(u-=1),(A.has("arrowdown")||A.has("s"))&&(u+=1),u!==0){const a=u/Math.abs(u);s.y+=a*h*o}if(d!==0){const a=d/Math.abs(d);M+=a*be*o,Math.abs(M)>Q&&(M=Math.sign(M)*Q)}const w=Math.exp(-3*o);if(M*=w,s.x+=M*o,me(r),r.time===0&&(s.x=0,s.y=-r.height+c.world.bottomYOffsetPx),W-=o,W<=0){const a=(Math.random()*2-1)*(r.width-20),l=-(c.enemy.speedMin+Math.random()*(c.enemy.speedMax-c.enemy.speedMin));de(r,a,r.height-20,l);const y=c.enemy.spawn.baseInterval,b=c.enemy.spawn.accelPerSec*r.time;W=Math.max(c.enemy.spawn.minInterval,y-b)}if(K-=o,K<=0&&r.enemies.length>0&&s.alive){const a=r.enemies[Math.random()*r.enemies.length|0],l=s.x-a.x,y=s.y-a.y,b=c.enemy.bulletSpeedMin+Math.random()*(c.enemy.bulletSpeedMax-c.enemy.bulletSpeedMin);fe(r,a.x,a.y,l,y,b),K=c.enemy.fireInterval}if(z-=o,s.alive&&z<=0){const a=Math.max(1,c.player.spray.count|0),l=c.player.spray.spreadDeg*Math.PI/180,b=Math.PI/2-l/2,E=a>1?l/(a-1):0;for(let g=0;g<a;g++){const v=b+E*g,_=Math.cos(v),f=Math.sin(v);ye(r,s.x,s.y+12,_,f,c.player.autoBulletSpeed)}z=c.player.autoFireInterval}pe(r,o),!s.alive&&s.lives<=0?U&&(r.time=0,r.enemies.length=0,r.playerBullets.length=0,r.enemyBullets.length=0,s.x=0,s.y=-r.height+c.world.bottomYOffsetPx,s.alive=!0,s.lives=c.world.playerLives,s.invincibleUntil=performance.now()+c.world.playerInvincibleMs,M=0,W=c.enemy.spawn.baseInterval,D=0,C=0,U=!1):U=!1;const B=new he({x:-r.width,y:-r.height,w:r.width*2,h:r.height*2},8,7);for(let a=0;a<r.enemies.length;a++){const l=r.enemies[a];B.insertRect(l.x-l.w*.5,l.y-l.h*.5,l.w,l.h,a)}for(let a=0;a<r.playerBullets.length;a++){const l=r.playerBullets[a],y=l.x-l.w*.5,b=l.y-l.h*.5,E=B.queryRect(y,b,l.w,l.h,[]);let g=!1;for(let v=0;v<E.length;v++){const _=E[v].ref,f=r.enemies[_];if(f&&ee(l.x,l.y,l.w,l.h,f.x,f.y,f.w,f.h)){if(f.hp-=1,r.playerBullets[a]=r.playerBullets[r.playerBullets.length-1],r.playerBullets.pop(),a--,g=!0,f.hp<=0){C=Math.min(c.scoring.comboMax,C+1);const p=c.scoring.enemyKillBase*Math.max(1,C)|0;if(D+=p,D>R){R=D;try{localStorage.setItem(c.scoring.highScoreKey,String(R))}catch{}}r.enemies[_]=r.enemies[r.enemies.length-1],r.enemies.pop()}break}}}if(r.player.alive)for(let a=0;a<r.enemyBullets.length;a++){const l=r.enemyBullets[a];if(!(performance.now()<s.invincibleUntil)&&ee(r.player.x,r.player.y,1,1,l.x,l.y,l.w,l.h)){s.lives-=1,C=0,s.lives>0?(s.x=0,s.y=-r.height+c.world.bottomYOffsetPx,s.invincibleUntil=performance.now()+c.world.playerInvincibleMs,r.enemyBullets=r.enemyBullets.filter(y=>Math.hypot(y.x-s.x,y.y-s.y)>32),M=0):s.alive=!1;break}}Y=0,k.beginFrame(),s.alive&&(!(performance.now()<s.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&T(s.x,s.y,14,18,0,.2,.9,1);for(let a=0;a<r.enemies.length;a++){const l=r.enemies[a];T(l.x,l.y,18,22,Math.PI,1,.3,.3)}for(let a=0;a<r.playerBullets.length;a++){const l=r.playerBullets[a],y=Math.atan2(l.vy,l.vx)-Math.PI*.5;T(l.x,l.y,6,10,y,1,1,.4)}for(let a=0;a<r.enemyBullets.length;a++){const l=r.enemyBullets[a],y=Math.atan2(l.vy,l.vx)-Math.PI*.5;T(l.x,l.y,6,10,y,1,.4,1)}k.setInstances(S,Y),k.draw(),ne()}function Se(){F.style.width||(F.style.width="100vw"),F.style.height||(F.style.height="100vh"),F.style.display="block"}Se();ne();function ne(){V?requestAnimationFrame(te):setTimeout(()=>te(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(V=!V)});
