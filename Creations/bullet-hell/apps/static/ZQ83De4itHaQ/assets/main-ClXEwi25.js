(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const h of s.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&n(h)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}})();class K{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const i=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(i)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(n=>n(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(n=>n({direction:e.direction,event:e.event}))}on(e,i){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(i)}off(e,i){const n=this.eventListeners.get(e)||[],r=n.indexOf(i);r>-1&&n.splice(r,1)}}const N=new K;class G{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const $=new G;function U(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error(t.getShaderInfoLog(n)||"Shader compile error"),t.deleteShader(n),null)}function X(t,e,i){const n=U(t,t.VERTEX_SHADER,e),r=U(t,t.FRAGMENT_SHADER,i),s=t.createProgram();return t.attachShader(s,n),t.attachShader(s,r),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error(t.getProgramInfoLog(s)||"Program link error"),t.deleteProgram(s),null)}const j=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,J=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function Z(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const i=X(e,j,J);e.useProgram(i),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const n=e.getUniformLocation(i,"u_halfViewSize"),r=new Float32Array([-.5,-.6,.5,-.6,0,.8]),s=e.createVertexArray();e.bindVertexArray(s);const h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const u=8;let c=512,f=0,o=new Float32Array(c*u);const l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,o.byteLength,e.DYNAMIC_DRAW);const d=u*4;let m=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,d,m),e.vertexAttribDivisor(1,1),m+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,d,m),e.vertexAttribDivisor(2,1),m+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,d,m),e.vertexAttribDivisor(3,1),m+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,d,m),e.vertexAttribDivisor(4,1);function B(g){if(g<=c)return;let y=c;for(;y<g;)y*=2;const F=new Float32Array(y*u);F.set(o.subarray(0,f*u)),o=F,c=y,e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,o.byteLength,e.DYNAMIC_DRAW)}function E(){const g=Math.min(window.devicePixelRatio||1,2),y=Math.floor(t.clientWidth*g),F=Math.floor(t.clientHeight*g);return(t.width!==y||t.height!==F)&&(t.width=y,t.height=F),e.viewport(0,0,t.width,t.height),e.useProgram(i),e.uniform2f(n,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:g}}function v(){e.clear(e.COLOR_BUFFER_BIT)}function S(g,y){B(y),f=y,o.set(g.subarray(0,y*u),0),e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferSubData(e.ARRAY_BUFFER,0,o.subarray(0,y*u))}function b(){f!==0&&(e.bindVertexArray(s),e.drawArraysInstanced(e.TRIANGLES,0,3,f))}return{gl:e,floatsPerInstance:u,resize:E,beginFrame:v,setInstances:S,draw:b}}function k(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class A{constructor(e,i,n,r){this.bounds=e,this.capacity=i,this.depth=n,this.maxDepth=r,this.items=[],this.children=null}subdivide(){const{x:e,y:i,w:n,h:r}=this.bounds,s=n*.5,h=r*.5,u=this.depth+1,c=this.capacity,f=this.maxDepth;this.children=[new A({x:e,y:i,w:s,h},c,u,f),new A({x:e+s,y:i,w:s,h},c,u,f),new A({x:e,y:i+h,w:s,h},c,u,f),new A({x:e+s,y:i+h,w:s,h},c,u,f)]}insert(e){if(!k(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let i=0;i<this.items.length;i++){const n=this.items[i];let r=!1;for(let s=0;s<4;s++)if(this.children[s].insert(n)){r=!0;break}r?(this.items[i]=this.items[this.items.length-1],this.items.pop(),i--):this.items[i]=n}}for(let i=0;i<4;i++)if(this.children[i].insert(e))return!0;return this.items.push(e),!0}query(e,i){if(!k(this.bounds,e))return i;for(let n=0;n<this.items.length;n++){const r=this.items[n];k(e,r)&&i.push(r)}return this.children&&(this.children[0].query(e,i),this.children[1].query(e,i),this.children[2].query(e,i),this.children[3].query(e,i)),i}}class Q{constructor(e,i=16,n=8){this.root=new A(e,i,0,n),this.bounds=e,this.capacity=i,this.maxDepth=n}clear(e=this.bounds){this.root=new A(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,i,n,r,s){const h={x:e,y:i,w:n,h:r,ref:s};this.root.insert(h)}queryRect(e,i,n,r,s=[]){return this.root.query({x:e,y:i,w:n,h:r},s)}}function ee(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1},enemies:[],playerBullets:[],enemyBullets:[]}}function te(t,e,i,n=40){t.enemies.push({x:e,y:i,vx:0,vy:n,w:16,h:16,hp:3})}function ie(t,e,i,n=0,r=-1,s=240){const h=Math.max(1e-4,Math.hypot(n,r));t.playerBullets.push({x:e,y:i,vx:n/h*s,vy:r/h*s,w:4,h:8})}function ne(t,e,i,n=0,r=1,s=160){const h=Math.max(1e-4,Math.hypot(n,r));t.enemyBullets.push({x:e,y:i,vx:n/h*s,vy:r/h*s,w:4,h:8})}function se(t,e){t.time+=e;for(let i=0;i<t.playerBullets.length;i++){const n=t.playerBullets[i];n.x+=n.vx*e,n.y+=n.vy*e,(n.x<-t.width||n.x>t.width||n.y<-t.height||n.y>t.height)&&(t.playerBullets[i]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),i--)}for(let i=0;i<t.enemyBullets.length;i++){const n=t.enemyBullets[i];n.x+=n.vx*e,n.y+=n.vy*e,(n.x<-t.width||n.x>t.width||n.y<-t.height||n.y>t.height)&&(t.enemyBullets[i]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),i--)}for(let i=0;i<t.enemies.length;i++){const n=t.enemies[i];n.x+=n.vx*e,n.y+=n.vy*e,n.y>t.height+40&&(t.enemies[i]=t.enemies[t.enemies.length-1],t.enemies.pop(),i--)}}function re(t,e=8){const i=t.player;i.x=Math.max(-t.width+e,Math.min(t.width-e,i.x)),i.y=Math.max(-t.height+e,Math.min(t.height-e,i.y))}$.setupViewport();N.init();const L=document.getElementById("glcanvas"),R=Z(L),a=ee(),p=document.createElement("div");p.style.position="fixed";p.style.left="8px";p.style.top="8px";p.style.padding="4px 6px";p.style.background="rgba(0,0,0,0.5)";p.style.color="#0f0";p.style.fontFamily="monospace";p.style.fontSize="12px";p.style.zIndex="1000";p.style.pointerEvents="none";document.body.appendChild(p);const oe=1e3;let _=[],P=0,q=performance.now(),C=!0;const w=new Set;window.addEventListener("keydown",t=>{w.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{w.delete(t.key.toLowerCase())});let M=!1;window.addEventListener("keydown",t=>{t.code==="Space"&&(M=!0)});window.addEventListener("keyup",t=>{t.code==="Space"&&(M=!1)});N.on("sideButton",()=>{M=!M});let W=0,T=0,V=0;const le=16384,O=R.floatsPerInstance;let x=new Float32Array(le*O),I=0;function D(t,e,i,n,r,s,h,u){const c=I*O;c+O>x.length||(x[c]=t,x[c+1]=e,x[c+2]=i,x[c+3]=n,x[c+4]=r,x[c+5]=s,x[c+6]=h,x[c+7]=u,I++)}function Y(t,e,i,n,r,s,h,u){return!(t+i*.5<r-h*.5||r+h*.5<t-i*.5||e+n*.5<s-u*.5||s+u*.5<e-n*.5)}function H(t){const{width:e,height:i}=R.resize();a.width=e*.5,a.height=i*.5;const n=t-q;for(q=t,_.push(n),P+=n;P>oe&&_.length>0;)P-=_.shift();if(_.length>0){const o=_.length,l=P/o,d=1e3/Math.max(1e-4,l),m=_.map(v=>1e3/Math.max(1e-4,v)).sort((v,S)=>v-S),B=Math.max(0,Math.floor(.01*o)),E=m[B];p.textContent=`fps ${d.toFixed(1)} | 1% ${E.toFixed(1)} | vsync ${C?"on":"off"}`}const r=Math.max(0,Math.min(.05,n*.001)),s=a.player,h=180;let u=0,c=0;if((w.has("arrowleft")||w.has("a"))&&(u-=1),(w.has("arrowright")||w.has("d"))&&(u+=1),(w.has("arrowup")||w.has("w"))&&(c-=1),(w.has("arrowdown")||w.has("s"))&&(c+=1),u!==0||c!==0){const o=Math.hypot(u,c)||1;s.x+=u/o*h*r,s.y+=c/o*h*r}if(re(a),W-=r,W<=0){const o=(Math.random()*2-1)*(a.width-20);te(a,o,a.height-20,-(40+Math.random()*30)),W=.75}if(T-=r,T<=0&&a.enemies.length>0){const o=a.enemies[Math.random()*a.enemies.length|0],l=s.x-o.x,d=s.y-o.y;ne(a,o.x,o.y,l,d,140+Math.random()*60),T=.6}V-=r,M&&V<=0&&(ie(a,s.x,s.y-12,0,-1,260),V=.1),se(a,r);const f=new Q({x:-a.width,y:-a.height,w:a.width*2,h:a.height*2},8,7);for(let o=0;o<a.enemies.length;o++){const l=a.enemies[o];f.insertRect(l.x-l.w*.5,l.y-l.h*.5,l.w,l.h,o)}for(let o=0;o<a.playerBullets.length;o++){const l=a.playerBullets[o],d=l.x-l.w*.5,m=l.y-l.h*.5,B=f.queryRect(d,m,l.w,l.h,[]);let E=!1;for(let v=0;v<B.length;v++){const S=B[v].ref,b=a.enemies[S];if(b&&Y(l.x,l.y,l.w,l.h,b.x,b.y,b.w,b.h)){b.hp-=1,a.playerBullets[o]=a.playerBullets[a.playerBullets.length-1],a.playerBullets.pop(),o--,E=!0,b.hp<=0&&(a.enemies[S]=a.enemies[a.enemies.length-1],a.enemies.pop());break}}}if(a.player.alive)for(let o=0;o<a.enemyBullets.length;o++){const l=a.enemyBullets[o];if(Y(a.player.x,a.player.y,1,1,l.x,l.y,l.w,l.h)){a.player.alive=!1;break}}I=0,R.beginFrame(),a.player.alive&&D(s.x,s.y,14,18,0,.2,.9,1);for(let o=0;o<a.enemies.length;o++){const l=a.enemies[o];D(l.x,l.y,18,22,Math.PI,1,.3,.3)}for(let o=0;o<a.playerBullets.length;o++){const l=a.playerBullets[o],d=Math.atan2(l.vy,l.vx)-Math.PI*.5;D(l.x,l.y,6,10,d,1,1,.4)}for(let o=0;o<a.enemyBullets.length;o++){const l=a.enemyBullets[o],d=Math.atan2(l.vy,l.vx)-Math.PI*.5;D(l.x,l.y,6,10,d,1,.4,1)}R.setInstances(x,I),R.draw(),z()}function ae(){L.style.width||(L.style.width="100vw"),L.style.height||(L.style.height="100vh"),L.style.display="block"}ae();z();function z(){C?requestAnimationFrame(H):setTimeout(()=>H(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(C=!C)});
