(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();class Le{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const n=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(n)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(i=>i(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(i=>i({direction:e.direction,event:e.event}))}on(e,n){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(n)}off(e,n){const i=this.eventListeners.get(e)||[],s=i.indexOf(n);s>-1&&i.splice(s,1)}}const xe=new Le;class ke{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const Ce=new ke;function we(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error(t.getShaderInfoLog(i)||"Shader compile error"),t.deleteShader(i),null)}function ze(t,e,n){const i=we(t,t.VERTEX_SHADER,e),s=we(t,t.FRAGMENT_SHADER,n),r=t.createProgram();return t.attachShader(r,i),t.attachShader(r,s),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)?r:(console.error(t.getProgramInfoLog(r)||"Program link error"),t.deleteProgram(r),null)}const De=`#version 300 es
precision highp float;
layout(location=0) in vec2 a_pos;            // base triangle vertex
layout(location=1) in vec2 a_i_position;     // instance world position (pixels, origin center)
layout(location=2) in vec2 a_i_scale;        // instance scale in pixels (width,height)
layout(location=3) in float a_i_rotation;    // instance rotation radians (0 up)
layout(location=4) in vec3 a_i_color;        // instance color
uniform vec2 u_halfViewSize;                 // half width/height in pixels
out vec3 v_color;
void main(){
  float s = sin(a_i_rotation);
  float c = cos(a_i_rotation);
  vec2 scaled = a_pos * a_i_scale;           // scale base triangle
  vec2 rotated = vec2(
    scaled.x * c - scaled.y * s,
    scaled.x * s + scaled.y * c
  );
  vec2 world = a_i_position + rotated;
  vec2 clip = world / u_halfViewSize;        // pixels -> clip
  gl_Position = vec4(clip, 0.0, 1.0);
  v_color = a_i_color;
}`,He=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`;function Te(t){const e=t.getContext("webgl2",{antialias:!0});if(!e)throw new Error("WebGL2 not supported");const n=ze(e,De,He);e.useProgram(n),e.clearColor(.02,.02,.03,1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);const i=e.getUniformLocation(n,"u_halfViewSize"),s=new Float32Array([-.5,-.6,.5,-.6,0,.8]),r=e.createVertexArray();e.bindVertexArray(r);const c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0);const p=8;let o=512,f=0,u=new Float32Array(o*p);const y=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,u.byteLength,e.DYNAMIC_DRAW);const S=p*4;let l=0;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,S,l),e.vertexAttribDivisor(1,1),l+=2*4,e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,S,l),e.vertexAttribDivisor(2,1),l+=2*4,e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,S,l),e.vertexAttribDivisor(3,1),l+=1*4,e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,S,l),e.vertexAttribDivisor(4,1);function h(g){if(g<=o)return;let w=o;for(;w<g;)w*=2;const b=new Float32Array(w*p);b.set(u.subarray(0,f*p)),u=b,o=w,e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,u.byteLength,e.DYNAMIC_DRAW)}function d(){const g=Math.min(window.devicePixelRatio||1,2),w=Math.floor(t.clientWidth*g),b=Math.floor(t.clientHeight*g);return(t.width!==w||t.height!==b)&&(t.width=w,t.height=b),e.viewport(0,0,t.width,t.height),e.useProgram(n),e.uniform2f(i,t.width*.5,t.height*.5),{width:t.width,height:t.height,dpr:g}}function m(){e.clear(e.COLOR_BUFFER_BIT)}function A(g,w){h(w),f=w,u.set(g.subarray(0,w*p),0),e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferSubData(e.ARRAY_BUFFER,0,u.subarray(0,w*p))}function M(){f!==0&&(e.bindVertexArray(r),e.drawArraysInstanced(e.TRIANGLES,0,3,f))}return{gl:e,floatsPerInstance:p,resize:d,beginFrame:m,setInstances:A,draw:M}}function fe(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}class ${constructor(e,n,i,s){this.bounds=e,this.capacity=n,this.depth=i,this.maxDepth=s,this.items=[],this.children=null}subdivide(){const{x:e,y:n,w:i,h:s}=this.bounds,r=i*.5,c=s*.5,p=this.depth+1,o=this.capacity,f=this.maxDepth;this.children=[new $({x:e,y:n,w:r,h:c},o,p,f),new $({x:e+r,y:n,w:r,h:c},o,p,f),new $({x:e,y:n+c,w:r,h:c},o,p,f),new $({x:e+r,y:n+c,w:r,h:c},o,p,f)]}insert(e){if(!fe(this.bounds,e))return!1;if(!this.children&&(this.items.length<this.capacity||this.depth>=this.maxDepth))return this.items.push(e),!0;if(!this.children){this.subdivide();for(let n=0;n<this.items.length;n++){const i=this.items[n];let s=!1;for(let r=0;r<4;r++)if(this.children[r].insert(i)){s=!0;break}s?(this.items[n]=this.items[this.items.length-1],this.items.pop(),n--):this.items[n]=i}}for(let n=0;n<4;n++)if(this.children[n].insert(e))return!0;return this.items.push(e),!0}query(e,n){if(!fe(this.bounds,e))return n;for(let i=0;i<this.items.length;i++){const s=this.items[i];fe(e,s)&&n.push(s)}return this.children&&(this.children[0].query(e,n),this.children[1].query(e,n),this.children[2].query(e,n),this.children[3].query(e,n)),n}}class Oe{constructor(e,n=16,i=8){this.root=new $(e,n,0,i),this.bounds=e,this.capacity=n,this.maxDepth=i}clear(e=this.bounds){this.root=new $(e,this.capacity,0,this.maxDepth),this.bounds=e}insertRect(e,n,i,s,r){const c={x:e,y:n,w:i,h:s,ref:r};this.root.insert(c)}queryRect(e,n,i,s,r=[]){return this.root.query({x:e,y:n,w:i,h:s},r)}}const We=1e4;function qe(){return{time:0,width:0,height:0,player:{x:0,y:0,alive:!0,radius:1,lives:3,invincibleUntil:0},enemies:[],playerBullets:[],enemyBullets:[],coins:[],powerups:[],enemyBulletPool:(()=>{const t=[];for(let e=0;e<We;e++)t.push({x:0,y:0,vx:0,vy:0,w:4,h:8});return t})()}}function Ue(t,e,n,i=40){t.enemies.push({x:e,y:n,vx:0,vy:i,w:16,h:16,hp:3})}function Ve(t,e,n,i=0,s=-1,r=240,c){const p=Math.max(1e-4,Math.hypot(i,s)),o={x:e,y:n,vx:i/p*r,vy:s/p*r,w:4,h:8};c&&(o.birthTime=t.time||0,o.sineAmp=c.sineAmp||0,o.sineFreqHz=c.sineFreqHz||0,o.sinePrevOffset=0),t.playerBullets.push(o)}function Ye(t,e,n,i=0,s=1,r=160,c){const p=Math.max(1e-4,Math.hypot(i,s)),o=t.enemyBulletPool.length>0?t.enemyBulletPool.pop():null;o&&(o.x=e,o.y=n,o.vx=i/p*r,o.vy=s/p*r,o.birthTime=t.time||0,o.sineAmp=0,o.sineFreqHz=0,o.sinePrevOffset=0,c&&(c.sineAmp!=null&&(o.sineAmp=c.sineAmp),c.sineFreqHz!=null&&(o.sineFreqHz=c.sineFreqHz)),t.enemyBullets.push(o))}function $e(t,e){t.time+=e;for(let i=0;i<t.playerBullets.length;i++){const s=t.playerBullets[i];if(s.sineAmp|0||s.sineFreqHz|0){const r=Math.max(1e-4,Math.hypot(s.vx,s.vy)),c=-s.vy/r,p=s.vx/r,o=t.time-(s.birthTime||0),f=(s.sineFreqHz||0)*o*Math.PI*2,u=Math.sin(f)*(s.sineAmp||0),y=u-(s.sinePrevOffset||0);s.x+=c*y,s.y+=p*y,s.sinePrevOffset=u}s.x+=s.vx*e,s.y+=s.vy*e,(s.x<-t.width||s.x>t.width||s.y<-t.height||s.y>t.height)&&(t.playerBullets[i]=t.playerBullets[t.playerBullets.length-1],t.playerBullets.pop(),i--)}for(let i=0;i<t.enemyBullets.length;i++){const s=t.enemyBullets[i];if(s.sineAmp|0||s.sineFreqHz|0){const r=Math.max(1e-4,Math.hypot(s.vx,s.vy)),c=-s.vy/r,p=s.vx/r,o=t.time-(s.birthTime||0),f=(s.sineFreqHz||0)*o*Math.PI*2,u=Math.sin(f)*(s.sineAmp||0),y=u-(s.sinePrevOffset||0);s.x+=c*y,s.y+=p*y,s.sinePrevOffset=u}s.x+=s.vx*e,s.y+=s.vy*e,(s.x<-t.width||s.x>t.width||s.y<-t.height||s.y>t.height)&&(t.enemyBullets[i]=t.enemyBullets[t.enemyBullets.length-1],t.enemyBullets.pop(),t.enemyBulletPool.push(s),i--)}for(let i=0;i<t.enemies.length;i++){const s=t.enemies[i];s.x+=s.vx*e,s.y+=s.vy*e,s.y>t.height+40&&(t.enemies[i]=t.enemies[t.enemies.length-1],t.enemies.pop(),i--)}const n=t.player;for(let i=0;i<t.coins.length;i++){const s=t.coins[i],r=n.x-s.x,c=n.y-s.y,p=Math.max(1e-4,Math.hypot(r,c)),o=s.speed||220;s.x+=r/p*o*e,s.y+=c/p*o*e,Math.hypot(s.x-n.x,s.y-n.y)<12&&(t.coins[i]=t.coins[t.coins.length-1],t.coins.pop(),i--)}for(let i=0;i<t.powerups.length;i++){const s=t.powerups[i];s.y+=(s.vy||-40)*e,s.y<-t.height-40&&(t.powerups[i]=t.powerups[t.powerups.length-1],t.powerups.pop(),i--)}}function Ge(t,e=8){const n=t.player;n.x=Math.max(-t.width+e,Math.min(t.width-e,n.x)),n.y=Math.max(-t.height+e,Math.min(t.height-e,n.y))}function Ne(t){for(let e=0;e<t.enemyBullets.length;e++)t.enemyBulletPool.push(t.enemyBullets[e]);t.enemyBullets.length=0}function Ke(t,e,n,i){const s=i*i;let r=0;for(let c=0;c<t.enemyBullets.length;c++){const p=t.enemyBullets[c],o=p.x-e,f=p.y-n;o*o+f*f<=s?t.enemyBulletPool.push(p):t.enemyBullets[r++]=p}t.enemyBullets.length=r}const Z=[{id:"L1",seed:12345,stages:[{id:"S1",phases:[{id:"P-popcorn-streams",actions:[{type:"spawn",enemy:"popcorn",pattern:"streamLinear",duration:8,rate:6,lane:"topRandom"},{type:"sleep",duration:2},{type:"spawn",enemy:"gunship",pattern:"burst",count:2,positions:"topLeftRightOffscreen"}]},{id:"P-bursters",actions:[{type:"sleep",duration:4},{type:"spawn",enemy:"burster",pattern:"streamRamping",duration:6,rate:{base:1.5,slope:.5}}]}],miniboss:{id:"minibossA"}},{id:"S2",phases:[{id:"P-popcorn-dense",actions:[{type:"spawn",enemy:"popcorn",pattern:"streamLinear",duration:10,rate:10}]}],boss:{id:"bossA"}}]},{id:"L2",seed:54321,stages:[{id:"S1",phases:[{id:"P-gunships",actions:[{type:"spawn",enemy:"gunship",pattern:"streamLinear",duration:8,rate:3,lane:"topLeftRightOffscreen"}]},{id:"P-bursters-more",actions:[{type:"sleep",duration:2},{type:"spawn",enemy:"burster",pattern:"streamRamping",duration:10,rate:{base:.8,slope:.6}}]}],boss:{id:"bossA"}}]}],J={popcorn:{id:"popcorn",size:{w:16,h:16},hp:1,score:10,movement:{use:"popcornDrift"},fire:{rate:1,shot:{use:"aimedSingle"}},onFireFx:{use:"onFireWindupShake"}},gunship:{id:"gunship",size:{w:22,h:20},hp:3,score:25,movement:{use:"gunshipSweep"},spawn:{side:"leftOrRightTop"},fire:null},burster:{id:"burster",size:{w:20,h:20},hp:5,score:50,movement:{use:"bursterStopAndBurst"},fire:{onPauseOnly:!0,shot:{use:"bursterVolley"}},onFireFx:{use:"onFireWindupShake"}},minibossA:{id:"minibossA",size:{w:60,h:44},hp:100,boss:!0,score:500,movement:{use:"hoverTopBand",override:{params:{yRatio:.85,sineXAmplitude:60}}},firePhases:[{duration:6,shot:{use:"spread5"}},{duration:8,shot:{use:"sineStream"}}]},bossA:{id:"bossA",size:{w:80,h:64},hp:1200,boss:!0,score:2e3,movement:{use:"hoverTopBand",override:{params:{yRatio:.88,sineXAmplitude:100}}},firePhases:[{untilHpRatio:.66,shot:{use:"spread5FastWide"}},{untilHpRatio:.33,shot:{use:"sineStream",override:{params:{rate:12}}}},{untilHpRatio:0,shot:{use:"bursterVolley"}}]}},Xe={fpsCap:60},Je={aimedSingle:{id:"aimedSingle",emit:"bullet",params:{speed:180,size:{w:6,h:10},color:[1,.9,.4],aimAtPlayer:!0}},spread5:{id:"spread5",emit:"group",params:{count:5,angleCenter:-90,angleSpreadDeg:40,speed:200,size:{w:6,h:10}}},sineStream:{id:"sineStream",emit:"sequence",params:{duration:2,rate:8,speed:180,sine:{amplitude:36,frequencyHz:2.2},size:{w:6,h:10}}},bursterVolley:{id:"bursterVolley",emit:"group",params:{count:15,angleCenter:-90,angleSpreadDeg:80,speed:160,sine:{amplitude:30,frequencyHz:3},size:{w:6,h:10}}},spread5FastWide:{use:"spread5",override:{params:{speed:240,angleSpreadDeg:60}}}};function Pe(t,e){if(!e)return t;const n=Array.isArray(t)?t.slice():{...t||{}};for(const i in e){const s=t?t[i]:void 0,r=e[i];n[i]=s&&typeof s=="object"&&!Array.isArray(s)&&typeof r=="object"&&!Array.isArray(r)?Pe(s,r):r}return n}function je(t){if(!t)return null;if(t.id&&t.params)return t;if(t.use){const e=Je[t.use];return e?Pe(e,t.override||null):null}return null}class Ze{constructor(e){this.api=e}emit(e,n,i,s){const r=je(e);if(!r)return;const c=r.params||{};if(r.emit==="bullet"){const p=this._computeDirection(c,n,i);this.api.fireEnemyBullet(n.x,n.y,p.dx,p.dy,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0);return}if(r.emit==="group"){const p=c.count|0,o=(c.angleSpreadDeg||0)*Math.PI/180,u=(c.angleCenter!=null?c.angleCenter:-90)*Math.PI/180-o*.5,y=p>1?o/(p-1):0;for(let S=0;S<p;S++){const l=u+S*y,h=Math.cos(l),d=Math.sin(l);this.api.fireEnemyBullet(n.x,n.y,h,d,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0)}return}if(r.emit==="sequence"){const p=c.duration||0,o=c.rate||0,f=Math.max(0,Math.floor(p*o));for(let u=0;u<f;u++){const y=this._computeDirection(c,n,i);this.api.fireEnemyBullet(n.x,n.y,y.dx,y.dy,c.speed||180,c.sine?{sineAmp:c.sine.amplitude||0,sineFreqHz:c.sine.frequencyHz||0}:void 0)}return}}_computeDirection(e,n,i){if(e.aimAtPlayer&&(i!=null&&i.target)){const r=i.target.x-n.x,c=i.target.y-n.y,p=Math.max(1e-4,Math.hypot(r,c));return{dx:r/p,dy:c/p}}const s=(e.angleCenter!=null?e.angleCenter:-90)*Math.PI/180;return{dx:Math.cos(s),dy:Math.sin(s)}}}function j(t){let e=t>>>0||1;function n(){return e^=e<<13,e>>>=0,e^=e>>>17,e>>>=0,e^=e<<5,e>>>=0,e>>>0}return{next(){return(n()>>>0)/4294967295},nextRange(i,s){return i+(s-i)*((n()>>>0)/4294967295)},nextInt(i,s){return Math.floor(j.mix(n())%(s-i+1))+i},get state(){return e>>>0}}}function ce(t,e){let n=t>>>0^2654435769;for(let i=0;i<e.length;i++)n^=e.charCodeAt(i)+114007148193232e5+(n<<6)+(n>>>2),n>>>=0;return n>>>0}class Qe{constructor(e,n,i,s=0,r=null){this.level=e,this.levelIndex=s,this.allLevels=r,this.world=n,this.api=i,this.time=0,this.done=!1,this.stageIndex=0,this.phaseStates=[],this.rng=j(e.seed>>>0),this.stageGateSpawned=!1,this._initStage()}_initStage(){const e=this.level.stages[this.stageIndex];this.stageGateSpawned=!1,this.phaseStates=e.phases.map((n,i)=>({id:n.id,t:0,cursor:0,asleepUntil:0,done:!1,rng:j(ce(this.level.seed,n.id+":"+i))}))}update(e){var r,c;if(this.done)return;const n=this.level.stages[this.stageIndex];this.time+=e;for(let p=0;p<this.phaseStates.length;p++){const o=this.phaseStates[p];if(o.done)continue;o.t+=e;const f=n.phases[p].actions;if(!(o.asleepUntil>this.time)){for(;o.cursor<f.length;){const u=f[o.cursor];if(u.type==="sleep"){o.asleepUntil=this.time+(u.duration||0),o.cursor++;break}else if(u.type==="spawn"){const y=this.time,S=u.pattern||"burst",l=u.lane||"topRandom";(!o.spawn||o.spawn.index!==o.cursor)&&(o.spawn={index:o.cursor,startedAt:y,emitted:0,nextAt:y});const h=o.spawn;if(S==="burst"){const d=u.count|0;for(let m=0;m<d;m++)this.api.spawnEnemyById(u.enemy,{lane:l,rng:o.rng});o.cursor++,o.spawn=null;continue}if(S==="streamLinear"){const d=u.duration||0,m=u.rate||0,A=y-h.startedAt;if(m>0){let M=0;for(;y>=h.nextAt&&M<1e3;)this.api.spawnEnemyById(u.enemy,{lane:l,rng:o.rng}),h.emitted++,h.nextAt+=1/m,M++}A>=d&&(o.cursor++,o.spawn=null);break}if(S==="streamRamping"){const d=u.duration||0,m=((r=u.rate)==null?void 0:r.base)||0,A=((c=u.rate)==null?void 0:c.slope)||0,M=y-h.startedAt,g=b=>Math.max(1e-4,m+A*b);let w=0;for(;y>=h.nextAt&&M<d&&w<2e3;){this.api.spawnEnemyById(u.enemy,{lane:l,rng:o.rng}),h.emitted++;const b=h.nextAt-h.startedAt,O=g(b);h.nextAt+=1/O,w++}M>=d&&(o.cursor++,o.spawn=null);break}o.cursor++,o.spawn=null}else o.cursor++}o.cursor>=f.length&&!o.spawn&&(o.done=!0)}}const i=this.phaseStates.every(p=>p.done),s=n.miniboss&&n.miniboss.id||n.boss&&n.boss.id||null;if(s&&this.stageGateSpawned&&!this.api.hasLivingById(s)){this.stageIndex+1<this.level.stages.length?(this.stageIndex++,this._initStage()):this.done=!0;return}i&&(s?this.stageGateSpawned||(this.api.spawnEnemyById(s,{lane:"topRandom",rng:j(ce(this.level.seed,"gate:"+s))}),this.stageGateSpawned=!0):this.stageIndex+1<this.level.stages.length?(this.stageIndex++,this._initStage()):this.done=!0)}loadLevel(e){this.allLevels&&(this.levelIndex=e,this.level=this.allLevels[this.levelIndex],this.time=0,this.done=!1,this.stageIndex=0,this._initStage())}}class Ee{constructor(e,n,i,s,r){this.world=e,this.entity=n,this.archetype=i,this.api=s,this.rng=r,this.nextFireAt=0,this.state={phase:"descend",pauseUntil:0,nextVxJitterAt:0,vxTarget:0},this.firePhaseIdx=0,this.firePhaseTime=0}update(e,n,i){var p,o,f,u,y,S,l,h,d,m,A,M,g,w,b,O,oe,q;const s=this.entity,r=(p=this.archetype)==null?void 0:p.movement,c=r==null?void 0:r.use;if(c==="popcornDrift"){const E=-(((o=r.params)==null?void 0:o.vy)||100);if(n>=this.state.nextVxJitterAt){const B=((f=r.params)==null?void 0:f.vxJitter)||60;this.state.vxTarget=(Math.random()*2-1)*B,this.state.nextVxJitterAt=n+(((u=r.params)==null?void 0:u.vxChangeEvery)||.7)}s.vx+=(this.state.vxTarget-s.vx)*Math.min(1,e*2),s.vy=E}else if(c==="gunshipSweep"){const E=((y=r.params)==null?void 0:y.yTopRatio)||.85,B=-this.world.height+2*this.world.height*E,U=3;s.vy=(B-s.y)*U;const V=20;s.y>this.world.height-V&&(s.y=this.world.height-V),s.y<-this.world.height+V&&(s.y=-this.world.height+V)}else if(c==="bursterStopAndBurst"){const E=-(((S=r.params)==null?void 0:S.vy)||60),B=((l=r.params)==null?void 0:l.stopYRatio)||.3,U=this.world.height*(B-1);this.state.phase==="descend"?(s.vy=E,s.y<=U&&(this.state.phase="pause",this.state.pauseUntil=n+(((h=r.params)==null?void 0:h.stopDuration)||2),s.vy=0,(m=(d=this.archetype)==null?void 0:d.fire)!=null&&m.onPauseOnly&&this.archetype.fire.shot&&this.api.fireShot(this.archetype.fire.shot,{x:s.x,y:s.y},{target:i},this.rng))):this.state.phase==="pause"?(s.vy=0,n>=this.state.pauseUntil&&(this.state.phase="resume")):s.vy=-(((A=r.params)==null?void 0:A.resumeVy)||E)}else if(c==="hoverTopBand"){s._hoverStartTime==null&&(s._hoverStartTime=n,s._hoverBaseX=s.x);const E=((M=r.params)==null?void 0:M.yRatio)||.8,B=-this.world.height+2*this.world.height*E,U=3;s.vy=(B-s.y)*U;const V=Math.min(((g=r.params)==null?void 0:g.sineXAmplitude)||80,this.world.width-40),Q=((w=r.params)==null?void 0:w.sineXFreqHz)||.25,ye=V*Math.sin(2*Math.PI*Q*(n-s._hoverStartTime));s.vx=0,s.x=(s._hoverBaseX||0)+ye;const _=20;s.x>this.world.width-_&&(s.x=this.world.width-_),s.x<-this.world.width+_&&(s.x=-this.world.width+_),s.y>this.world.height-_&&(s.y=this.world.height-_),s.y<-this.world.height+_&&(s.y=-this.world.height+_)}if((O=(b=this.archetype)==null?void 0:b.fire)!=null&&O.rate&&n>=this.nextFireAt){const E=this.archetype.fire.shot;this._fireWithFx(E,i),this.nextFireAt=n+1/this.archetype.fire.rate}if(Array.isArray((oe=this.archetype)==null?void 0:oe.firePhases)&&this.archetype.firePhases.length>0){const E=this.entity,B=this.archetype.firePhases,U=(E._maxHp||E.hp)>0?E.hp/(E._maxHp||E.hp):0;if(B.some(_=>_.untilHpRatio!=null)){let _=0;for(let D=0;D<B.length;D++){const ve=B[D];ve.untilHpRatio!=null&&U<=ve.untilHpRatio&&(_=Math.min(D+1,B.length-1))}this.firePhaseIdx=_}else{this.firePhaseTime+=e;let _=0;for(let D=0;D<B.length;D++){if(_+=B[D].duration||5,this.firePhaseTime<=_){this.firePhaseIdx=D;break}D===B.length-1&&this.firePhaseTime>_&&(this.firePhaseTime=0,this.firePhaseIdx=0)}}const Q=B[this.firePhaseIdx]||B[0],ye=Q.rate?1/Q.rate:.3;if(n>=this.nextFireAt){const _=Q.shot||((q=this.archetype.fire)==null?void 0:q.shot);this._fireWithFx(_,i),this.nextFireAt=n+ye}}}_fireWithFx(e,n){var r,c,p,o,f;const i=this.entity,s=(r=this.archetype)==null?void 0:r.onFireFx;if((s==null?void 0:s.use)==="onFireWindupShake"){const u=((c=s.params)==null?void 0:c.windupMs)||120,y=((p=s.params)==null?void 0:p.shakeMs)||160,S=((o=s.params)==null?void 0:o.windupBackPx)||6,l=performance.now();i.fxWindupEndMs=l+u,i.fxWindupBackPx=S,i.fxShakeEndMs=l+u+y,i.fxShakePx=((f=s.params)==null?void 0:f.shakePx)||3}this.api.fireShot(e,{x:i.x,y:i.y},{target:n},this.rng)}}const x={world:{playerLives:9999,playerInvincibleMs:4e3,bottomYOffsetPx:24},player:{moveSpeedY:180,keyAccel:1200,maxKeySpeed:220,frictionPerSec:3,scrollImpulse:40,autoFireInterval:.06,autoBulletSpeed:320,spray:{count:3,spreadDeg:12,sine:{amplitude:10,frequencyHz:6}}},enemy:{body:{w:18,h:22},speedMin:40,speedMax:70,fireInterval:.2,bulletSpeedMin:140,bulletSpeedMax:200,spawn:{baseInterval:.3,minInterval:.01,accelPerSec:.06},hp:1},bullets:{size:{w:6,h:10}},quadtree:{capacity:8,maxDepth:7},scoring:{enemyKillBase:10,comboMax:9,highScoreKey:"bh_highscore"},ui:{showPerfOverlay:!0,perfOffsetTopPx:8}};Ce.setupViewport();xe.init();const X=document.getElementById("glcanvas"),ee=Te(X),a=qe();a.player.x=0;a.player.y=-a.height+x.world.bottomYOffsetPx;a.player.lives=x.world.playerLives;const I=document.createElement("div");I.style.position="fixed";I.style.left="8px";I.style.top=String(x.ui.perfOffsetTopPx)+"px";I.style.padding="4px 6px";I.style.background="rgba(0,0,0,0.5)";I.style.color="#0f0";I.style.fontFamily="monospace";I.style.fontSize="12px";I.style.zIndex="1000";I.style.pointerEvents="auto";I.style.whiteSpace="pre";let se=!0;document.body.appendChild(I);I.addEventListener("click",()=>{se=!se,I.style.opacity=se?"1":"0"});I.style.opacity=se?"1":"0";const R=document.createElement("div");R.style.position="fixed";R.style.right="8px";R.style.top="8px";R.style.padding="4px 6px";R.style.background="rgba(0,0,0,0.5)";R.style.color="#0f0";R.style.fontFamily="monospace";R.style.fontSize="12px";R.style.zIndex="1000";R.style.pointerEvents="none";R.style.whiteSpace="pre";R.style.textAlign="right";document.body.appendChild(R);const P=document.createElement("div");P.style.position="fixed";P.style.left="50%";P.style.top="8px";P.style.transform="translateX(-50%)";P.style.width="60%";P.style.height="10px";P.style.background="rgba(255,255,255,0.1)";P.style.border="1px solid rgba(255,255,255,0.3)";P.style.borderRadius="6px";P.style.overflow="hidden";P.style.zIndex="1000";P.setAttribute("data-testid","boss-hp-bar");const re=document.createElement("div");re.style.height="100%";re.style.width="0%";re.style.background="linear-gradient(90deg, #f44, #f8a)";P.appendChild(re);document.body.appendChild(P);P.style.display="none";const v=document.createElement("div");v.style.position="fixed";v.style.left="50%";v.style.top="50%";v.style.transform="translate(-50%, -50%)";v.style.background="rgba(0,0,0,0.7)";v.style.color="#fff";v.style.padding="16px 20px";v.style.border="1px solid rgba(255,255,255,0.25)";v.style.borderRadius="8px";v.style.fontFamily="monospace";v.style.fontSize="14px";v.style.zIndex="1200";v.style.textAlign="center";v.style.whiteSpace="pre";v.setAttribute("data-testid","level-complete");v.style.display="none";document.body.appendChild(v);const de=document.createElement("div");de.style.marginBottom="8px";v.appendChild(de);const z=document.createElement("button");z.textContent="Continue";z.style.marginTop="8px";z.style.padding="6px 10px";z.style.fontFamily="monospace";z.style.fontSize="14px";z.style.cursor="pointer";z.addEventListener("click",()=>{T.levelIndex+1<Z.length?(T.loadLevel(T.levelIndex+1),v.style.display="none"):(de.textContent=`YOU WIN

score ${F(k)}
hi ${F(L)}
combo_peak ${F(te)}
misses ${F(he)}`,z.style.display="none",v.style.display="block")});v.appendChild(z);const et=1e3;let N=[],ae=0,be=performance.now(),pe=!0;const H=new Set;window.addEventListener("keydown",t=>{H.add(t.key.toLowerCase())});window.addEventListener("keyup",t=>{H.delete(t.key.toLowerCase())});window.addEventListener("keydown",t=>{t.code});window.addEventListener("keyup",t=>{t.code});let le=!1;xe.on("sideButton",()=>{le=!0});xe.on("scrollWheel",({direction:t})=>{if(!a.player.alive)return;const n=performance.now(),i=t==="up"?1:-1;i===Ae&&n-Se<tt?ge+=1:ge=1,Se=n,Ae=i,W+=i*ge*st});let me=0;const ne=new WeakMap,Ie=new Ze({fireEnemyBullet:(t,e,n,i,s,r)=>Ye(a,t,e,n,i,s,r)}),T=new Qe(Z[0],a,{spawnEnemyById:(t,{lane:e,rng:n})=>Fe(t,e,n),hasLivingById:t=>{for(let e=0;e<a.enemies.length;e++)if(a.enemies[e]._enemyId===t)return!0;return!1}},0,Z);function Fe(t,e,n){var u,y,S,l,h,d;const i=J[t];if(!i)return;const s=30;let r=0,c=a.height+s;e==="topRandom"||!e?(r=(n&&typeof n.next=="function"?n.next()*2-1:Math.random()*2-1)*(a.width-20),c=a.height+s):e==="topLeftRightOffscreen"&&(r=(n&&typeof n.next=="function"?n.next():Math.random())<.5?-a.width-s:a.width+s,c=a.height-20);let p=-80;((u=i.movement)==null?void 0:u.use)==="gunshipSweep"&&(p=0),((y=i.movement)==null?void 0:y.use)==="bursterStopAndBurst"&&(p=-60),((S=i.movement)==null?void 0:S.use)==="popcornDrift"&&(p=-100),Ue(a,r,c,p);const o=a.enemies[a.enemies.length-1];if(!o)return;o._enemyId=t,o._maxHp=i.hp!=null?i.hp:o.hp,i.size&&(o.w=i.size.w,o.h=i.size.h),i.hp!=null&&(o.hp=i.hp),((l=i.movement)==null?void 0:l.use)==="gunshipSweep"&&(o.vx=r<0?Math.abs(((h=i.movement.params)==null?void 0:h.vx)||70):-Math.abs(((d=i.movement.params)==null?void 0:d.vx)||70));const f=new Ee(a,o,i,{fireShot:(m,A,M,g)=>Ie.emit(m,A,M,g)},j(ce(n&&n.state?n.state:1,t+":"+String(a.enemies.length))));ne.set(o,f)}let k=0,Y=0,L=0,te=0,he=0;try{L=parseInt(localStorage.getItem(x.scoring.highScoreKey)||"0",10)||0}catch{L=0}function F(t){return String((t|0)<0?0:t|0).padStart(8,"0")}let W=0,Se=0,Ae=0,ge=1;const tt=2e3,st=x.player.scrollImpulse,nt=x.player.keyAccel,Me=x.player.maxKeySpeed,ue=ee.floatsPerInstance;let ie=16384,C=new Float32Array(ie*ue),G=0;function it(t){if(t<=ie)return;let e=ie;for(;e<t;)e*=2;const n=new Float32Array(e*ue);n.set(C.subarray(0,G*ue)),C=n,ie=e}function K(t,e,n,i,s,r,c,p){G+1>ie&&it(G+1);const o=G*ue;C[o]=t,C[o+1]=e,C[o+2]=n,C[o+3]=i,C[o+4]=s,C[o+5]=r,C[o+6]=c,C[o+7]=p,G++}function _e(t,e,n,i,s,r,c,p){return!(t+n*.5<s-c*.5||s+c*.5<t-n*.5||e+i*.5<r-p*.5||r+p*.5<e-i*.5)}function Be(t){var S;const{width:e,height:n}=ee.resize();a.width=e*.5,a.height=n*.5,window.__debug&&(window.__debug.frameCount=(window.__debug.frameCount|0)+1);const i=t-be;for(be=t,N.push(i),ae+=i;ae>et&&N.length>0;)ae-=N.shift();if(N.length>0&&se){const l=N.length,h=ae/l,d=1e3/Math.max(1e-4,h),m=N.map(g=>1e3/Math.max(1e-4,g)).sort((g,w)=>g-w),A=Math.max(0,Math.floor(.01*l)),M=m[A];I.textContent=`fps ${d.toFixed(1)}
1% ${M.toFixed(1)}
vsync ${pe?"on":"off"}`}R.textContent=`score ${F(k)}
hi ${F(L)}`;const s=Math.max(0,Math.min(1/Math.max(1,Xe.fpsCap),i*.001)),r=a.player,c=x.player.moveSpeedY;let p=0,o=0;if((H.has("arrowleft")||H.has("a"))&&(p-=1),(H.has("arrowright")||H.has("d"))&&(p+=1),(H.has("arrowup")||H.has("w"))&&(o-=1),(H.has("arrowdown")||H.has("s"))&&(o+=1),o!==0){const l=o/Math.abs(o);r.y+=l*c*s}if(p!==0){const l=p/Math.abs(p);W+=l*nt*s,Math.abs(W)>Me&&(W=Math.sign(W)*Me)}const f=Math.exp(-3*s);W*=f,r.x+=W*s,Ge(a),a.time===0&&(r.x=0,r.y=-a.height+x.world.bottomYOffsetPx),T.update(s);for(let l=0;l<a.enemies.length;l++){const h=a.enemies[l];let d=ne.get(h);!d&&h._enemyId&&J[h._enemyId]&&(d=new Ee(a,h,J[h._enemyId],{fireShot:(m,A,M,g)=>Ie.emit(m,A,M,g)},null),ne.set(h,d)),d&&d.update(s,a.time,a.player)}if(me-=s,r.alive&&me<=0){const l=Math.max(1,x.player.spray.count|0),h=(x.player.spray.spreadDeg||0)*Math.PI/180,m=Math.PI/2-h/2,A=l>1?h/(l-1):0;for(let M=0;M<l;M++){const g=m+A*M,w=Math.cos(g),b=Math.sin(g),O=x.player.spray.sine||{amplitude:0,frequencyHz:0};Ve(a,r.x,r.y+12,w,b,x.player.autoBulletSpeed,{sineAmp:O.amplitude||0,sineFreqHz:O.frequencyHz||0})}me=x.player.autoFireInterval}$e(a,s),!r.alive&&r.lives<=0?le&&(a.time=0,a.enemies.length=0,a.playerBullets.length=0,Ne(a),r.x=0,r.y=-a.height+x.world.bottomYOffsetPx,r.alive=!0,r.lives=x.world.playerLives,r.invincibleUntil=performance.now()+x.world.playerInvincibleMs,W=0,k=0,Y=0,le=!1):le=!1,!r.alive&&r.lives<=0?(v.textContent=`GAME OVER

score ${F(k)}
hi ${F(L)}
combo_peak ${F(te)}
misses ${F(he)}`,v.style.display="block",z.style.display="none"):z.style.display="inline-block";const u=new Oe({x:-a.width,y:-a.height,w:a.width*2,h:a.height*2},8,7);for(let l=0;l<a.enemies.length;l++){const h=a.enemies[l];u.insertRect(h.x-h.w*.5,h.y-h.h*.5,h.w,h.h,l)}for(let l=0;l<a.playerBullets.length;l++){const h=a.playerBullets[l],d=h.x-h.w*.5,m=h.y-h.h*.5,A=u.queryRect(d,m,h.w,h.h,[]);let M=!1;for(let g=0;g<A.length;g++){const w=A[g].ref,b=a.enemies[w];if(b&&_e(h.x,h.y,h.w,h.h,b.x,b.y,b.w,b.h)){if(b.hp-=1,a.playerBullets[l]=a.playerBullets[a.playerBullets.length-1],a.playerBullets.pop(),l--,M=!0,b.hp<=0){Y=Math.min(x.scoring.comboMax,Y+1),Y>te&&(te=Y);const O=x.scoring.enemyKillBase*Math.max(1,Y)|0;if(k+=O,k>L){L=k;try{localStorage.setItem(x.scoring.highScoreKey,String(L))}catch{}}try{ne.delete(b)}catch{}a.enemies[w]=a.enemies[a.enemies.length-1],a.enemies.pop();const oe=Math.random()<.8?1:0;for(let q=0;q<oe;q++)a.coins.push({x:b.x,y:b.y,speed:240})}break}}}if(a.player.alive){for(let l=0;l<a.enemyBullets.length;l++){const h=a.enemyBullets[l];if(!(performance.now()<r.invincibleUntil)&&_e(a.player.x,a.player.y,1,1,h.x,h.y,h.w,h.h)){r.lives-=1,he+=1,Y=0,r.lives>0?(r.x=0,r.y=-a.height+x.world.bottomYOffsetPx,r.invincibleUntil=performance.now()+x.world.playerInvincibleMs,Ke(a,r.x,r.y,32),W=0):(r.alive=!1,typeof navigator<"u"&&navigator.vibrate&&navigator.vibrate(200));break}}for(let l=0;l<a.coins.length;l++){const h=a.coins[l];if(Math.hypot(h.x-r.x,h.y-r.y)<12){if(k+=5,k>L){L=k;try{localStorage.setItem(x.scoring.highScoreKey,String(L))}catch{}}a.coins[l]=a.coins[a.coins.length-1],a.coins.pop(),l--}}for(let l=0;l<a.powerups.length;l++){const h=a.powerups[l];Math.hypot(h.x-r.x,h.y-r.y)<14&&(x.player.spray.count=Math.min(20,(x.player.spray.count|0)+2),x.player.spray.spreadDeg=Math.min(60,(x.player.spray.spreadDeg||0)+6),a.powerups[l]=a.powerups[a.powerups.length-1],a.powerups.pop(),l--)}}G=0,ee.beginFrame(),r.alive&&(!(performance.now()<r.invincibleUntil)||Math.floor(performance.now()*.01)%2===0)&&K(r.x,r.y,14,18,0,.2,.9,1);for(let l=0;l<a.enemies.length;l++){const h=a.enemies[l];let d=0,m=0;const A=performance.now();h.fxWindupEndMs&&A<h.fxWindupEndMs?m-=h.fxWindupBackPx||0:h.fxShakeEndMs&&A<h.fxShakeEndMs&&(d+=(Math.random()*2-1)*(h.fxShakePx||0),m+=(Math.random()*2-1)*(h.fxShakePx||0)),K(h.x+d,h.y+m,18,22,Math.PI,1,.3,.3)}for(let l=0;l<a.playerBullets.length;l++){const h=a.playerBullets[l],d=Math.atan2(h.vy,h.vx)-Math.PI*.5;K(h.x,h.y,6,10,d,1,1,.4)}for(let l=0;l<a.enemyBullets.length;l++){const h=a.enemyBullets[l],d=Math.atan2(h.vy,h.vx)-Math.PI*.5;K(h.x,h.y,6,10,d,1,.4,1)}for(let l=0;l<a.coins.length;l++){const h=a.coins[l];K(h.x,h.y,8,8,0,1,.84,.2)}for(let l=0;l<a.powerups.length;l++){const h=a.powerups[l];K(h.x,h.y,14,14,Math.PI/4,.7,.4,1)}ee.setInstances(C,G),ee.draw();let y=null;for(let l=0;l<a.enemies.length;l++){const h=a.enemies[l],d=h._enemyId;if(d&&((S=J[d])!=null&&S.boss)){y=h;break}}if(y&&y._maxHp>0){P.style.display="block";const l=Math.max(0,Math.min(1,y.hp/y._maxHp));re.style.width=String(Math.floor(l*100))+"%"}else P.style.display="none";T.done&&!y?v.style.display!=="block"&&(de.textContent=`LEVEL COMPLETE

score ${F(k)}
hi ${F(L)}
combo_peak ${F(te)}
misses ${F(he)}`,v.style.display="block"):v.style.display="none",Re()}function rt(){X.style.width||(X.style.width="100vw"),X.style.height||(X.style.height="100vh"),X.style.display="block"}rt();Re();function Re(){pe?requestAnimationFrame(Be):setTimeout(()=>Be(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(pe=!pe)});window.__debug=window.__debug||{};window.__debug.enemiesSummary=()=>({count:a.enemies.length,types:a.enemies.reduce((t,e)=>{const n=e._enemyId||"unknown";return t[n]=(t[n]||0)+1,t},{})});window.__debug.bulletsSummary=()=>({player:a.playerBullets.length,enemy:a.enemyBullets.length});window.__debug.frameCount=0;window.__debug.getBossInfo=()=>{var t;for(let e=0;e<a.enemies.length;e++){const n=a.enemies[e],i=n._enemyId;if(i&&((t=J[i])!=null&&t.boss))return{id:i,hp:n.hp,maxHp:n._maxHp||n.hp}}return null};window.__debug.damageBoss=(t=10)=>{var e;for(let n=0;n<a.enemies.length;n++){const i=a.enemies[n],s=i._enemyId;if(s&&((e=J[s])!=null&&e.boss)){if(i.hp-=t,i.hp<=0){try{ne.delete(i)}catch{}a.enemies[n]=a.enemies[a.enemies.length-1],a.enemies.pop()}return!0}}return!1};window.__debug.forceSpawnGate=()=>{const t=Z[0].stages[T.stageIndex],e=t.miniboss&&t.miniboss.id||t.boss&&t.boss.id;if(e){Fe(e,"topRandom",j(ce(Z[0].seed,"forceGate")));try{T.stageGateSpawned=!0}catch{}return!0}return!1};window.__debug.setStage=t=>{if(typeof t!="number")return!1;const e=Z[0].stages.length-1,n=Math.max(0,Math.min(e,t));return T.stageIndex=n,T._initStage&&T._initStage(),!0};
