(function(){"use strict";function p(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function y(s,t){const o=new Float32Array(16);for(let n=0;n<4;n++){const r=s[n],c=s[n+4],e=s[n+8],f=s[n+12];o[n]=r*t[0]+c*t[1]+e*t[2]+f*t[3],o[n+4]=r*t[4]+c*t[5]+e*t[6]+f*t[7],o[n+8]=r*t[8]+c*t[9]+e*t[10]+f*t[11],o[n+12]=r*t[12]+c*t[13]+e*t[14]+f*t[15]}return o}function h(s,t,o,n){const r=1/Math.tan(s/2),c=1/(o-n),e=new Float32Array(16);return e[0]=r/t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(n+o)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*n*o*c,e[15]=0,e}function M(s,t){const[o,n,r]=t,c=s.slice(0);return c[12]=s[0]*o+s[4]*n+s[8]*r+s[12],c[13]=s[1]*o+s[5]*n+s[9]*r+s[13],c[14]=s[2]*o+s[6]*n+s[10]*r+s[14],c[15]=s[3]*o+s[7]*n+s[11]*r+s[15],c}function g(s,t){const o=Math.sin(t),n=Math.cos(t),r=new Float32Array([1,0,0,0,0,n,o,0,0,-o,n,0,0,0,0,1]);return y(s,r)}function w(s,t){const o=Math.sin(t),n=Math.cos(t),r=new Float32Array([n,0,-o,0,0,1,0,0,o,0,n,0,0,0,0,1]);return y(s,r)}let a=null;function A(s,t,o,n){const r=Math.sin(n),c=Math.cos(n),e=Math.sin(o),f=Math.cos(o),i=t[0]*c-t[2]*r,u=t[0]*r+t[2]*c,l=t[1]*f-u*e,F=t[1]*e+u*f;s[0]=i,s[1]=l,s[2]=F}self.onmessage=s=>{const t=s.data;if(t){if(t.type==="compute"){const{timeSec:o,aspect:n,cameraDistance:r=4}=t,c=h(Math.PI/3,n,.1,100);let e=p();e=M(e,[0,0,-r]);let f=p();f=w(f,o),f=g(f,o*.7);const u=y(c,e).buffer,l=f.buffer;self.postMessage({type:"result",vp:{buffer:u,byteOffset:0,byteLength:16*4},model:{buffer:l,byteOffset:0,byteLength:16*4}},[u,l]);return}if(t.type==="initGeometry"){const{buffer:o,length:n}=t;o&&typeof n=="number"&&(a=new Float32Array(o,0,n),a=a.slice(0)),self.postMessage({type:"initAck"});return}if(t.type==="transform"){if(!a)return;const{timeSec:o}=t,n=o*.7,r=o,c=new Float32Array(a.length),e=[0,0,0];for(let i=0;i<a.length;i+=3)e[0]=a[i],e[1]=a[i+1],e[2]=a[i+2],A(e,e,n,r),c[i]=e[0],c[i+1]=e[1],c[i+2]=e[2];const f=c.buffer;self.postMessage({type:"transformResult",positions:{buffer:f,byteOffset:0,byteLength:c.byteLength}},[f]);return}}}})();
