(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();class oe{constructor(){this.sideButtonEnabled=!0,this.scrollWheelEnabled=!0,this.eventListeners=new Map}init(e={}){this.sideButtonEnabled=e.sideButtonEnabled??!0,this.scrollWheelEnabled=e.scrollWheelEnabled??!0,this.sideButtonEnabled&&this.setupSideButtonListener(),this.scrollWheelEnabled&&this.setupScrollWheelListener(),e.keyboardFallback!==!1&&this.setupKeyboardFallback()}setupSideButtonListener(){window.addEventListener("sideClick",e=>{this.sideButtonEnabled&&this.handleSideButtonClick(e)})}setupScrollWheelListener(){window.addEventListener("scrollUp",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"up",event:e})}),window.addEventListener("scrollDown",e=>{this.scrollWheelEnabled&&this.handleScrollWheel({direction:"down",event:e})})}setupKeyboardFallback(){window.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault();const r=new CustomEvent("sideClick",{detail:{source:"keyboard"}});window.dispatchEvent(r)}})}handleSideButtonClick(e){(this.eventListeners.get("sideButton")||[]).forEach(n=>n(e))}handleScrollWheel(e){(this.eventListeners.get("scrollWheel")||[]).forEach(n=>n({direction:e.direction,event:e.event}))}on(e,r){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(r)}off(e,r){const n=this.eventListeners.get(e)||[],s=n.indexOf(r);s>-1&&n.splice(s,1)}}const U=new oe;class ne{constructor(){this.screenWidth=240}setupViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.name="viewport",document.head.appendChild(e)),e.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"}}const re=new ne;function O(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function T(t,e){const r=new Float32Array(16);for(let n=0;n<4;n++){const s=t[n],i=t[n+4],a=t[n+8],l=t[n+12];r[n]=s*e[0]+i*e[1]+a*e[2]+l*e[3],r[n+4]=s*e[4]+i*e[5]+a*e[6]+l*e[7],r[n+8]=s*e[8]+i*e[9]+a*e[10]+l*e[11],r[n+12]=s*e[12]+i*e[13]+a*e[14]+l*e[15]}return r}function se(t,e,r,n){const s=1/Math.tan(t/2),i=1/(r-n),a=new Float32Array(16);return a[0]=s/e,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=s,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(n+r)*i,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*n*r*i,a[15]=0,a}function ie(t,e){const[r,n,s]=e,i=t.slice(0);return i[12]=t[0]*r+t[4]*n+t[8]*s+t[12],i[13]=t[1]*r+t[5]*n+t[9]*s+t[13],i[14]=t[2]*r+t[6]*n+t[10]*s+t[14],i[15]=t[3]*r+t[7]*n+t[11]*s+t[15],i}function ae(t,e){const r=Math.sin(e),n=Math.cos(e),s=new Float32Array([1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1]);return T(t,s)}function le(t,e){const r=Math.sin(e),n=Math.cos(e),s=new Float32Array([n,0,-r,0,0,1,0,0,r,0,n,0,0,0,0,1]);return T(t,s)}re.setupViewport();U.init();const c=document.getElementById("glcanvas"),o=c.getContext("webgl2",{antialias:!0});o||console.error("WebGL2 not supported");function Y(t,e,r){const n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error(t.getShaderInfoLog(n)||"Shader compile error"),t.deleteShader(n),null)}function ce(t,e,r){const n=Y(t,t.VERTEX_SHADER,e),s=Y(t,t.FRAGMENT_SHADER,r),i=t.createProgram();return t.attachShader(i,n),t.attachShader(i,s),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(console.error(t.getProgramInfoLog(i)||"Program link error"),t.deleteProgram(i),null)}const fe=`#version 300 es
precision highp float;
layout(location=0) in vec3 a_position;
layout(location=1) in vec3 a_color;
layout(location=2) in vec3 a_offset; // per-instance world-space offset
uniform mat4 u_vp;     // view-projection
uniform mat4 u_model;  // model rotation only
out vec3 v_color;
void main(){
  v_color = a_color;
  vec3 rotated = (u_model * vec4(a_position, 1.0)).xyz;
  vec3 worldPos = rotated + a_offset;
  gl_Position = u_vp * vec4(worldPos, 1.0);
}`,ue=`#version 300 es
precision highp float;
in vec3 v_color;
out vec4 outColor;
void main(){
  outColor = vec4(v_color, 1.0);
}`,I=ce(o,fe,ue);o.useProgram(I);const E=new Float32Array([1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1]),de=new Float32Array([1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,1,1,0,1,1,0,1,1,0,1,1,0,1,0,1,1,0,1,1,0,1,1,0,1,0,1,1,0,1,1,0,1,1,0,1,1]),$=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),j=o.createVertexArray();o.bindVertexArray(j);const X=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,X);o.bufferData(o.ARRAY_BUFFER,E,o.DYNAMIC_DRAW);o.enableVertexAttribArray(0);o.vertexAttribPointer(0,3,o.FLOAT,!1,0,0);const he=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,he);o.bufferData(o.ARRAY_BUFFER,de,o.STATIC_DRAW);o.enableVertexAttribArray(1);o.vertexAttribPointer(1,3,o.FLOAT,!1,0,0);const pe=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,pe);o.bufferData(o.ELEMENT_ARRAY_BUFFER,$,o.STATIC_DRAW);const N=o.getUniformLocation(I,"u_vp"),V=o.getUniformLocation(I,"u_model");o.enable(o.DEPTH_TEST);o.clearColor(.03,.03,.05,1);function ye(){const t=Math.min(window.devicePixelRatio||1,2),e=Math.floor(c.clientWidth*t),r=Math.floor(c.clientHeight*t);(c.width!==e||c.height!==r)&&(c.width=e,c.height=r),o.viewport(0,0,c.width,c.height)}const f=document.createElement("div");f.style.position="fixed";f.style.left="8px";f.style.top="8px";f.style.padding="4px 6px";f.style.background="rgba(0,0,0,0.5)";f.style.color="#0f0";f.style.fontFamily="monospace";f.style.fontSize="12px";f.style.zIndex="1000";f.style.pointerEvents="none";document.body.appendChild(f);const me=1e3;let A=[],F=0,z=performance.now(),g=!1,v=256,u=0;const k=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,k);o.bufferData(o.ARRAY_BUFFER,v*3*4,o.DYNAMIC_DRAW);o.enableVertexAttribArray(2);o.vertexAttribPointer(2,3,o.FLOAT,!1,0,0);o.vertexAttribDivisor(2,1);let y=new Float32Array(v*3);function Ae(t){if(t<=v)return;let e=v;for(;e<t;)e*=2;const r=new Float32Array(e*3);r.set(y.subarray(0,u*3)),y=r,v=e,o.bindBuffer(o.ARRAY_BUFFER,k),o.bufferData(o.ARRAY_BUFFER,v*3*4,o.DYNAMIC_DRAW),u>0&&o.bufferSubData(o.ARRAY_BUFFER,0,y.subarray(0,u*3))}function J(t){Ae(u+1);const e=u*3;y[e]=t[0],y[e+1]=t[1],y[e+2]=t[2],o.bindBuffer(o.ARRAY_BUFFER,k),o.bufferSubData(o.ARRAY_BUFFER,e*4,y.subarray(e,e+3)),u++}function ve(){u<=0||u--}let B=4;const M=50;let we=0;function G(t,e){let r=1,n=0,s=t;for(;s>0;)r/=e,n+=r*(s%e),s=Math.floor(s/e);return n}function Q(){const t=++we,e=G(t,2),r=G(t,3),n=-e,s=2*Math.PI*r,i=Math.sqrt(Math.max(0,1-n*n)),a=i*Math.cos(s),l=i*Math.sin(s),h=n,d=a*M,R=l*M,S=B+h*M;return[d,R,S]}let H=0,q=0,x=1;const Re=2e3;let L=0,p=0;U.on("scrollWheel",({direction:t,event:e})=>{const r=performance.now(),n=t==="up"?1:-1;n===q&&r-H<Re?x+=1:x=1,H=r,q=n,L+=n*x});for(let t=0;t<10;t++)J(Q());function K(t){ye();const e=t*.001,r=t-z;for(z=t,A.push(r),F+=r;F>me&&A.length>0;)F-=A.shift();if(A.length>0){const l=A.length,h=F/l,d=1e3/Math.max(1e-4,h),R=A.map(_=>1e3/Math.max(1e-4,_)).sort((_,te)=>_-te),S=Math.max(0,Math.floor(.01*l)),ee=R[S];f.textContent=`fps ${d.toFixed(1)} | 1% ${ee.toFixed(1)} | cubes ${u} | vsync ${g?"on":"off"}`}const n=Math.max(0,Math.min(.1,r*.001)),s=Math.exp(-.4*n);L*=s,p+=L*n;let i=0;if(p>=1?(i=Math.floor(p),p-=i):p<=-1&&(i=Math.ceil(p),p-=i),i>0)for(let l=0;l<i;l++)J(Q());else if(i<0)for(let l=0;l<-i;l++)ve();o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const a=c.width/Math.max(1,c.height);if(m&&!D&&(D=!0,w.postMessage({type:"compute",timeSec:e*b,aspect:a,cameraDistance:B})),C&&W)o.uniformMatrix4fv(N,!1,C),o.uniformMatrix4fv(V,!1,W);else{const l=se(Math.PI/3,a,.1,100);let h=O();h=ie(h,[0,0,-B]);let d=O();d=le(d,e*b),d=ae(d,e*.7*b);const R=T(l,h);o.uniformMatrix4fv(N,!1,R),o.uniformMatrix4fv(V,!1,d)}m&&ge(e*b),o.bindVertexArray(j),o.drawElementsInstanced(o.TRIANGLES,$.length,o.UNSIGNED_SHORT,0,Math.max(1,u)),Z()}function be(){c.style.width||(c.style.width="100vw"),c.style.height||(c.style.height="100vh"),c.style.display="block"}be();Z();function Z(){g?requestAnimationFrame(K):setTimeout(()=>K(performance.now()),0)}window.addEventListener("keydown",t=>{(t.key==="v"||t.key==="V")&&(g=!g)});let b=1;U.on("sideButton",()=>{b*=-1});let w,m=!1,D=!1,C=null,W=null,P=!1;function Ee(){try{const t=E.buffer.slice(0);w.postMessage({type:"initGeometry",buffer:t,length:E.length},[t])}catch{}}function Fe(){try{w=new Worker(new URL(""+new URL("worker-BAEKGTU-.js",import.meta.url).href,import.meta.url),{type:"module"}),w.onmessage=t=>{const e=t.data;if(e){if(e.type==="result"){const{vp:r,model:n}=e;r&&r.buffer&&(C=new Float32Array(r.buffer,r.byteOffset||0,(r.byteLength||16*4)/4)),n&&n.buffer&&(W=new Float32Array(n.buffer,n.byteOffset||0,(n.byteLength||16*4)/4)),D=!1,m=!0}else if(e.type==="initAck")m=!0;else if(e.type==="transformResult"){const{buffer:r,byteOffset:n=0,byteLength:s}=e.positions||{};if(r&&s===E.byteLength){const i=new Float32Array(r,n,E.length);o.bindBuffer(o.ARRAY_BUFFER,X),o.bufferSubData(o.ARRAY_BUFFER,0,i)}P=!1}}},w.onerror=()=>{m=!1}}catch{m=!1}}Fe();Ee();function ge(t){!m||P||(P=!0,w.postMessage({type:"transform",timeSec:t}))}
